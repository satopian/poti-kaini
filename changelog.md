## 23/02/03 v6.22.0
### LuminousからLightboxへ
画像をポップアップ表示する時に使用していたLuminousの開発が中止になり、中止されただけでなくLICENSEファイルもリポジトリから削除されてしまったため、LICENSE不明になってしまいました。  
そのため、Lightboxを使用してポップアップ表示する事にしました。  
しかし、Lightboxでは、Luminousではできていたいくつかの事ができません。
そのためLightboxを改造して、見た目と機能をLuminousに近づけてその問題を解決しました。

- 透過PNGを透過させる  
Lightboxでは背景色が白になってしまうため、背景部分を透明にして透過PNG画像の背景が透明になるようにしました。  
- 画像長押しで保存  
Lightboxでは画像の長押しで画像を保存できない仕様のため、CSSを調整して画像の長押しで画像を保存できるようにしました。  
- 前後のナビゲーションバーの位置を変更
画像の上に表示されていた前後の画像を表示するための矢印を、左右の横幅からの位置に変更して、左右に余白があるときは画像の上でではなく、画面の左右にナビゲーションの矢印を表示するようにしました。  
- 閉じるボタン  
前後ナビゲーションの矢印以外のどこを押しても画像を閉じるようにしました。  
しがたって閉じるボタンは必要がなくなりました。  
- 画像読み込み中の画像  
ローディング中の円のGIFを、透過PNGで作成した大小ふたつの円に変更。CSS3で画像が回転します。

## 23/01/30 v6.21.1
### 描画中にCookieが消えてしまった時に投稿不能になる問題を修正
HTMLにセットしたCookieの値と、実際のCookieの値を照合するシステムを廃止。
投稿時にCookieが存在しない場合もユーザーコードのCookieを再発行して投稿できるようにしました。
ユーザーのブラウザからCookieが消えた場合だけでなく、サーバのWAFの設定によってCookieが照合できなくなる問題にも対応できていると思います。  
また、PaintBBS NEOとしぃペインターの拡張ヘッダに情報を詰め込んでいましたが、拡張ヘッダではなく、GETパラメータで取得する方式に切り替えました。
互換性維持のため、GETで取得できない場合は拡張ヘッダでも取得できるようにしました。  

## 23/01/25 v6.20.5
### ChickenPaint Be更新
- グリッド設定のモーダルを開いた時に数値入力項目にフォーカスが移動する元の仕様が動作していなかったのを修正。
- グリッド設定の数値入力確定のエンターキーで画面が移動してペイント画面から移動する問題が残っていたのを修正。
仮に意図どおりに処理が行われなかった場合でも、エンターキーが無効になるだけにして被害が最小になるように。  
その上で、グリッド･ぼかし･変形確定のエンターキーが意図どおりに動作する事を確認しました。  
- グリッド、ぼかしの表示終了後はモーダルを破棄するようにしました。
この問題は改造前のChickenPaintに存在していた問題で、新しく発生したものではありません。
### Klecksで特定のキーが入力できなくなっていたのを修正しました

` "+", ";", "=","-","s","h","r"`が入力できなくなっていました。  
これは、v6.20.2で、ctrl+rによる画面更新を防止するためにキーのDefaultの動作をキャンセルした時に発生したものです。  
ctrlキーまたは⌘キーが押下されている事を確認した上でその組み合わせの場合のみDefaultの動作をキャンセルするようにしました。  

## 23/01/24 v6.20.3
### ChickenPaint Be更新
- `innerHTML`でテキストを使用している箇所をテキストしか入らない`textContent`へ。
- ぼかしフィルタのモーダルを開いた時に数値入力項目にフォーカスが移動する元の仕様が動作していなかったのを修正。
- ヘルプの3つの項目のモーダルを非表示にしても構築されたモーダルのHTMLが見えないだけで残ってしまっていたのを消去するようにしました。

## 23/01/24 v6.20.2.5
### ペイント画面では｢リロード｣｢拡大縮小｣｢履歴｣｢ページを保存｣のブラウザデフォルトのショートカットを無効化
- ｢ctrl+r｣による再読み込み、｢ctrl++｣によるブラウザ全体の拡大縮小、｢ctrl+h｣による履歴の表示｢ctrl+s｣によるページを保存といったブラウザのデフォルトのショートカットをChickenPaint、Tegaki、Klecksのペイント画面で無効化しました。
- ChickenPaintのショートカットキーを変更。｢ctrl+y｣をやり直し、｢ctrl+h｣を変形にしました。
- Macの時はマスク適用、マスク削除のショートカットキーを｢⌘+｣に。

## 23/01/23 v6.20.0
### ChickenPaint Be更新 ショートカットが効かなく問題を修正
これは、かなり以前から存在していた問題です。  
｢透明部分を保護｣等のチェックボックスや｢合成方法｣等のセレクトボックスを操作すると、ChickenPaintのショートカットが効かなくなる問題がありました。  
 ショートカットが使えなくなった時は、画面のどこかをペンでタッチするとショートカットが再び使えるようになるので、操作を続行できにはできていたのですが、｢ctrl++｣で画面を拡大しようとした時にブラウザのショートカットが有効になりUIが拡大されてしまったり、｢ctrl+s｣で画像をPCに保存しようとしたらブラウザのデフォルトのショートカットとして認識されてしまって、画像の保存ではなくHTMLが保存される等の問題が発生していました。
時間がかかりましたが、何とか問題を特定し、解決方法を見つける事ができました。  
問題があった箇所を操作しても、ChickenPaintのショートカットは有効なまま維持されます。  
ブラウザのデフォルトのショートカットと入れ替わってしまう問題は解消されました。

しかし、念のため、UIの拡大のショートカットに使用される｢+｣｢-｣と、保存に使用される｢s｣のブラウザのショートカットキーを最初から無効化する処理も追加して、意図しない動作にならないようにしました。  


## 23/01/20 v6.19.5
### ChickenPaint Be更新。アイコンフォントを軽量化。
- icomoonで、fontawesomeのアイコンフォントのファイルサイズを1/18に。
これまでは使用していないフォントを大量に読み込んでいました。
- ドロップダウンメニューのHTMLをBootstrap5.3形式に統一しました。


## 23/01/20 v6.19.3
### ChickenPaint更新
### 拡大率縮小率を緩やかに
- ズームの拡大率を141%に、縮小率を70.92%に変更しました。  
これまでは、拡大時に200%拡大され、縮小時には50%に縮小されていました。
この拡縮率は大きすぎるため、二度拡大すると200%になるように調整しました。  
また、拡大縮小を繰り返すと、100%、200%または50%に戻らなくなる事がありました。  
拡大縮小を繰り返しても、100%、200%または50%に正確に戻るようになりました。

- 70.92%に縮小した時に描線がガタガタに表示されてしまうため、ズーム時に補完して表示するオプションをデフォルトで有効になるようにしました。  
ドットの状態を確認したい時には、この機能をオフにする必要があるため｢表示｣→｢ズームをなめらかに表示する｣をオフにしてご利用ください。  

#### 未翻訳箇所の日本語訳を行いました。
- ショートカットキー一覧、送信ダイヤログの未翻訳箇所の日本語訳を追加しました。
｢Right｣｢Left｣も｢右｣｢左｣に翻訳しました。  
この間の更新でレイヤーマスクやブラシサイズのスライダーのショートカットキーも追加されていますので、見やすくなったショートカットキー一覧のヘルプをぜひご利用ください。  
#### コードの最適化 
- 必要がなくなったコードを整理しました。  
余計なコードが残っていると、そのコードに何らかの意味があるかもしれないとなって、今後の保守作業に影響がでます。  
また、Bootstrap5の文法にそって記述していれば追加のJavaScriptが必要ない事が判明した箇所のJavaScriptのコードの撤去も行いました。  

## 2024/01/16 v6.19.1
### ChickenPaint更新
#### 未翻訳箇所の日本語訳を行いました。
ドロップダウンメニューのメニュー項目にカーソルを合わせた時に英語の説明文が表示されていましたが、表示する項目を整理して必要なものだけ残し、それを日本語に翻訳しました。
#### レイヤーマスクのショートカットキーを追加しました。

![2024_01_16_レイヤーマスクのショートカットキーを追加](https://github.com/satopian/Petit_Note/assets/44894014/80361d7d-acf8-4256-98fa-27f7bf09d2e9)

レイヤーマスクのサムネイルをクリックして使用するショートカットキーを追加しました。
これにはマニュアルに記載がなかったものの機能として最初から存在していたものも含まれます。

- シフト+クリックでレイヤーマスクの表示/非表示
- alt+クリックでレイヤーマスクのマスク部分を表示
- ctrl+クリックでレイヤーマスク適用
- シフト+ctrl+クリックでレイヤーマスク削除

このショートカットキーの追加で、レイヤーパレットの右クリックメニューに存在していた処理を行う事がでるようになりました。  
どのぐらいの方が使っていたのかわかりませんが、レイヤーパレットの右クリックメニューにはグループ結合や、レイヤーマスクの表示/非表示等数多くの項目が存在していました。  
CSSフレームワークBootstrapをBootstrap4からBootstrap5対応に変更する作業で、この右クリックメニューを再実装する事ができなかったため、多くの埋め合わせを行いました。
レイヤーパレットにグループ結合アイコンを追加したのもそのためです。  
しかし、iPad等最初から右クリックが使えない環境の場合は、より操作しやすいChickenPaintになっていると思います。

## 2024/01/14 v6.19.0
### バグ修正
トップページの静的HTMLにアクセスするだけではブラウザにCookieはセットされませんが、その静的HTMLのトップページからペイントボタンを押した時にCookieの有無をチェックする機能が働いて、｢Cookieが存在しません｣というエラーになっていました。  
ペイントボタンを2回押せば動くには動くのですが、静的HTMLからのpostでCookieを確認するのは無理があるので、ペイント時にはCookieを確認しないようにしました。  

### ChickenPaint更新
#### レイヤーパレットにグループ結合アイコンを追加しました。  
 通常の下のレイヤーと結合で結合するとクリッピングが解除されてしまいますが、レイヤーグループ内で下のレイヤーとクリッピングしていれば、グループ結合でレイヤーを結合しても、クリッピングが維持できます。     また、たくさんレイヤーがある時はグループ化して閉じればレイヤーパレットの場所を取らず便利です。  
しかし、これまではグループレイヤーを結合するには右クリックメニューから選ぶか上段のメニューからグループ結合を選択する必要がありました。   
そして、レイヤーの右クリックメニュー機能を再実装できなかったので、実質上のメニューか、ショートカットキーでしか操作できなくなっていました。  
そこで、レイヤーパレットに｢グループ結合｣アイコンを追加しました。   
1タップで、グループフォルダ内のレイヤーを結合して1つにします。    

![2024_01_14_レイヤーパレットにグループ結合アイコンを追加](https://github.com/satopian/Petit_Note/assets/44894014/db8d88a3-6bc8-4d3f-a612-1a2e000d9aaa)

#### レイヤーパレットのマスクアイコンの動作を変更
 レイヤーパレットのマスクアイコンの動作を変更しました。  
選択しているレイヤーにマスクが無い時は｢マスク追加｣になり、マスクが存在している時は｢マスク適用｣に変わります。      
これによりペン操作で簡単にレイヤーマスクを適用できようになります。    
これまでの、マスクアイコンには｢マスク追加｣機能しかありませんでした。  
 
![2024_01_13_マスクアイコンでレイヤーマスク適用](https://github.com/satopian/Petit_Note/assets/44894014/29f16dc9-e69c-4126-b660-9b52d7db906d)

#### ショートカットキーをさらに追加

- SHIFT+Mでマスク削除  

![Screen-2024-01-13_22-18-57](https://github.com/satopian/Petit_Note/assets/44894014/294559d8-04dd-4690-bd5c-b3a7adbcbda4)

追加されたショートカットキーの一覧はこのページを確認して覚える必要はありません。  
メニューの横にショートカットキーが表示されていますので、追加されたショートカットキーはそこからご確認できます。  


## 2024/01/13 v6.18.9
### ChickenPaint更新
#### 緩やかに変化するスライダーの動作を修正
- 右クリックで、ブラシパレットのスライダーが緩やかに変化するようになる機能を改善しました。  
従来は、ブラシサイズと、不透明度以外のスライダーも右クリックによる緩やかなスライダーの変化の動作に入っていましたが、スライダーの種類によっては28%や56%でスライダーが動かなくなる等の問題が発生していました。  
また、右クリックしながらスライダーを調整するのは結構面倒です。  

##### 以下の改善を行いました
- 右クリックによるドラッグに加え、SHIFT+左ドラッグでもスライダーが緩やかに変化するようにしました。  
ペンを使っている時は、シフトキーを押しながらペンでスライダーを調整するだけで緩やかに変化するようになります。  
- ブラシサイズと不透明度以外の期待通りに動作しないスライダーには緩やかなスライダーの変化を適用しないようにしました。  
ブラシサイズと不透明度以外のスライダーが途中で止まったり、スライダーが入力できなくなったりする項目のスライダーは最初から緩やかに変化するスライダーのモードに入らないようにしました。  

##### アプリ名更新

｢ChickenPaint｣のロゴ部分を｢ChickenPaint Be｣に変更して、改造版である事が一目でわかるようにしました。
掲示板のエンドユーザーの方には直接関係ありませんが、｢ChickenPaint Be｣のソースコードはここにあります。
[satopian/ChickenPaint_Be: お絵かき掲示板Petit Noteのためのbootstrap5対応のChickenPaint](https://github.com/satopian/ChickenPaint_Be/tree/main)
改造したものを再配布する時のライセンス上の条件にソースコード公開の義務があります。   
そのためヘルプページにも｢ChickenPaint Be｣のGitHubのリポジトリのURLを記載しました。  

## 2024/01/11 v6.18.8
### ChickenPaint更新

#### ChickenPaintのショートカットキーを追加
##### 全レイヤー結合とグループ結合、マスク適用のショートカットキーを追加しました
##### オリジナルのChickenPaintからのショートカットキー追加一覧は以下

[ChickenPaintのショートカットキーを拡張しました｜さとぴあ](https://note.com/satopian/n/n79fee71aa102)
- R+左クリックでキャンバスの回転
- Hでレイヤーの左右反転  
- Wで水彩
- Aでエアブラシ  
- Sで薄消しゴム
- Dで指先ツール  
- Cで混色ツール
- SHIFT+CTRL+Eで全レイヤー結合
- SHIFT+CTRL+Gでグループ結合
- CTRL+Mでマスク適用

### レイヤーパレットに｢下のレイヤーと結合｣アイコンを追加
- ｢下のレイヤーと結合｣をペンによる操作で簡単に実現できるようにするため、レイヤーパレットに｢下のレイヤーと結合｣アイコンを追加しました。

![image](https://github.com/satopian/ChickenPaint_Be/assets/44894014/019fbe39-9382-4639-95c6-bfbe8ed47af8)

### ヘルプページのショートカットキー一覧の翻訳

英語のみだったショートカットキー一覧の説明ページの日本語辞書を追加して、日本語と英語を自動的に切り替えで表示できるようになりました。
これで、ほとんどの日本語未翻訳箇所の日本語翻訳作業が完了しました。

[satopian/ChickenPaint_Be: お絵かき掲示板Petit Noteのためのbootstrap5対応のChickenPaint](https://github.com/satopian/ChickenPaint_Be/tree/main)


## 2024/01/09 v6.18.6
### ChickenPaint更新
- レイヤーを変形しようとした時にレイヤーが非表示または不透明度0%の時にも、非表示、不透明度0%というメッセージをポップオーバーで出すようにしました。  
これまでは、単に変形できないだけで、なぜ変形できないのかを説明するメッセージの表示がありませんでした。  
- レイヤー名をマウスで変更できなくなっていたのを修正しました。  
ペンタブレットやタッチデバイスの場合はダブルタップでレイヤー名の変更が可能ですが、マウスではそれが出来ません。  
従来は、マウスの右クリックで、｢マスク追加｣｢クリッピング｣｢レイヤー名変更｣などのコンテキストメニューが開いていたので、そのメニューを使ってレイヤー名を変更する事が可能でした。  
しかしながらBootstrap5に更新した結果、同じコンテキストメニューを表示を表示する事が困難になってしまったため、マウスの場合は右クリックでレイヤー名の変更になるようにコードを変更しました。   
たったそれだけの作業でしたが、解明が困難な軽微なエラーメッセージが表示される問題を解決するためだけに20時間以上費やしてしまいました。  
- ファイルメニューで｢PCに保存｣(CTRL+S)した時のファイル名に投稿日時分秒が入るようになりました。  
これによりファイル名を変更して保存しなくても、同一フォルダに途中経過を保存できるようになりました。
これまではファイル名が｢oekaki.png｣固定でした。
#### ChickenPaint Be
改造版に固有の機能が存在し、オリジナルには存在している機能が無くなっている事や、改造版に固有の問題が発生している可能性もある事から、オリジナルの｢ChickenPaint｣と区別するために、改造版の｢ChickenPaint｣の名称を｢ChickenPaint Be｣としました。

[satopian/ChickenPaint_Be: お絵かき掲示板Petit Noteのためのbootstrap5対応のChickenPaint](https://github.com/satopian/ChickenPaint_Be)

## 2024/01/07 v6.18.5
### ChickenPaint更新
####  ChickenPaintの各パレットやドロップダウンメニュー、ポップオーバーを作成しているCSSフレームワークBootstrapをバージョン4からバージョン5に変更しました。  
- Bootstrap4ではjQueryで制御していた箇所が、Bootstrap5ではJavaScriptとなり、大幅なコードの書き換えが必要になりました。  
また、従来の書き方を単に置き換えただけでは意図した動作にならないケースがいくつかあり、新しく処理を追加して対応しました。  
気が遠くなるような作業量でしたが、将来廃止予定のJavaScriptがBootstrap4のコードに入っていたため、これから先の数年後もChickenPaintが使えるようにするために必要な作業でした。  
[satopian/ChickenPaint_Be: お絵かき掲示板Petit Noteのためのbootstrap5対応のChickenPaint](https://github.com/satopian/ChickenPaint_Be)  
↑
ビルドするためのソースコードはここにありますので、気になる方はご確認ください。  

#### ChickenPaintのダイヤログ、ポップオーバーの日本語未翻訳箇所を翻訳して実装しました

![Screen-2024-01-06_14-51-15](https://github.com/satopian/Petit_Note/assets/44894014/4a81d9b1-e146-4f59-8ed1-39ddd4e82b1f)

![Screen-2024-01-06_15-15-24](https://github.com/satopian/Petit_Note/assets/44894014/e6e98ef2-9ccd-48a3-bee8-552a24e6615d)

#### 変形確定前に別のレイヤーを選択、または新規レイヤーを追加しようとした時に表示されるダイヤログの動作を改良

https://github.com/satopian/Petit_Note/assets/44894014/10c54317-482f-4d7b-9327-99629578e640

- 変形確定前にレイヤーを追加しようとすると変形を確定する取り消すなどの操作を促すダイヤログが表示されますが、従来の動作では、変形確定のエンターキーの押下で変形は確定されるものの、ダイヤログはすぐには消えず、レイヤーの追加も行われませんでした。  
今回の修正により、エンターキーによる変形の確定と同時にダイヤログは閉じられ、かつ、レイヤーも追加されるようになります。  
また、一連のダイヤログの日本語対応も行いました。

## 2023/12/30 v6.17.9
### ChickenPaintのグリッド設定のバグを修正しました
ChickenPaintのグリッド設定で数値入力確定のエンターキーを押下すると、掲示板トップに画面が移動して描いていた絵が消えてしまうバグを修正しました。

## 2023/12/27 v6.17.8
### ユーザーコードのCookieが何らかの理由で消えてしまった場合でも投稿が可能になるように修正しました
- ｢ユーザーコードが一致しません｣というエラーが発生して本来なら投稿できるはずの投稿に失敗する事例の報告がありました。
そのためユーザーコードのCookie単体でのチェックではなく、SESSIONデータにもユーザーコードをセットしてCookieとSESSIONのどちらかが一致すれば投稿ができるようにしました。
- お絵かき画面の起動時にCookieチェックを行い、ユーザーコードの存在とCookieまたはSESSIONのユーザーコードと一致するかどうかを事前にチェックするようにしました。  
描画がはじまったあとで問題が発生するのではなく、描き始める前の時点で問題が発生している時はエラーにします。  
これにより、描画作業が失なわれる確率を下げる事ができます。  

## 2023/12/26 v6.16.18
### Tegaki更新
- Tegakiのブラシサイズが1pxの時にも円カーソルを表示するようにしました。
- 従来は1pxの時には表示されない仕様でした。
- 1pxの円カーソルは小さすぎて見えないので、1pxの時は2px相当の円カーソルを表示します。
- モバイルでは円カーソルを表示しないようにしました。
タッチしている時にしかカーソルが動かないため。
### PaintBBS NEO更新
- 開発元リポジトリのバージョン表記にあわせて、v1.6.1に。
バージョン表記以外は前回更新したものと同じです。
### Klecks更新
- プレビューウィンドウの拡大縮小機能が追加されました。

## 2023/12/24 v6.16.15
- 独自カスタマイズ版のChickenPaintを更新しました。
描画時の円カーソル表示を別の方法で再実装しました。  
タッチデバイス以外のPC等で描画時にも円カーソルを表示します。


## 2023/12/23 v6.16.12.1
### ペイントアプリを更新
- 独自カスタマイズ版のChickenPaintを更新しました。
~~描画中の円カーソルの表示をあきらめ、もとに戻しました。~~
- 独自カスタマイズ版のPaintBBS NEOを更新しました。
タッチデバイスでは円カーソルを表示しないようにしました。

## 2023/12/22 v6.16.10
### ペイントアプリを更新
- Klecksを更新しました。
- 独自カスタマイズ版のChickenPaintを更新しました。
- 独自カスタマイズ版のPaintBBS NEOを更新しました。

NEO、ChickenPaintともに、描画中にも円カーソルを表示するようにしました。  
また、オリジナルのPaintBBSの動作にあわせて8px以下のブラシサイズの時には円カーソルを出さないようにしていたPaintBBS NEOの仕様を変更して1pxの時にも2px相当の円カーソルを表示するようにしました。 
これは、Windows Inkのペンタブレット+Chromeの時に、ブラウザのデフォルトのカーソルが消える問題に対応するための改造です。   
視認性が高い黒の1pxの描線の時には、カーソルが見えなくても描線が見えるので何とかなるのですが、視認性が悪い薄い色の線を長く引きたい時にはカーソルが見える必要があるからです。


## 2023/12/17 v6.16.9
コード整理。コードが3行短くなりました。

## 2023/12/11 v6.16.8
### Klecks更新

## 2023/12/02 v6.16.7
### ChickenPaintのショートカットキーを更に追加しました
指先ツールと、混色ツールのショートカットキーを追加しました。

#### 追加されたショートカットキーの一覧
- ｢R+左クリック｣キャンバスの回転
- ｢H｣レイヤーの左右反転
- ｢S｣薄消しゴムに切り替え
- ｢W｣水彩ブラシに切り替え
- ｢A｣エアブラシに切り替え
- ｢D｣指先ツールに切り替え
- ｢C｣混色ツールに切り替え

https://github.com/satopian/Petit_Note/assets/44894014/2075f812-19d4-4409-9478-9bf0a49a3c59

## 2023/11/30 v6.16.6
### EdgeのIEモードでしぃペインター起動した時に、JavaScriptの構文エラーが発生していたのを修正しました
- Javaアプレットのしぃペインター(注意:PaintBBS NEOではない)は、CheerpJよりも、Javaプラグインを使って起動したほうが安定しています。
- そのためにはJavaが起動するブラウザが必要です。そのブラウザのひとつ、EdgeのIEモードで、JavaScriptの構文エラーが発生していたのを修正しました。
- IEでは動作しないアロー関数を、従来のfunction()を使った関数に置き換えました。

## 2023/11/30 v6.16.5
### PaintBBS NEOのショートカットキーAltキーのキーアップ時に、Firefoxのメニューバーの表示/非表示の動作になる問題を修正
- Altキーのキーアップのデフォルトの動作をキャンセルしてこの問題を修正しました。
- PaintBBS NEO+Firefox時の問題は解決できましたが、CheerpJを使って起動したしぃペインターでは、AltキーでFirefoxのメニューバーの表示/非表示の動作が発生してしまいます。
CheerpJが起動した時点で、キーアップイベントの取得ができなくなるようです。
Chromeではこの問題はなく、FirefoxとFirefox派生ブラウザで発生します。

## 2023/11/29 v6.16.3
### tegaki.js更新
- ｢Altキー｣押下直後にショートカットキーが効かなくなる問題が、tegaki.jsでも発生していました。
- ChickenPaintと同じように｢Altキー｣を離した時点で｢altキー｣のデフォルトの動作をキャンセルする事でこの問題を解決しました。

## 2023/11/28 v6.16.1
### ChickenPaint更新。以前から存在していた、｢altキー｣押下直後にショートカットキー効かなくなる問題を修正しました。
- ｢R+左クリック｣でキャンバスを回転するショートカットキーの動作確認中に、キャンバスが回転せずブラシツール等の描線が意図せず引かれてしまう問題に気が付きました。  
一連のショートカットキーの追加などのスクリプトの改造が原因かもしれないと疑い、調査した結果、もともとこの動作だった事がわかりました。  
しかしながら、｢altキー｣を押して色をスポイトそのまま、｢R+左クリック｣でキャンバスを回転といった処理をしたい時もあります。
この問題の原因を探るため、｢altキー｣で追加している処理をすべて削除してみましたが問題は解決しませんでした。  
原因はaltキーのデフォルトの動作そのものでした。  
altキーを離した時点でaltキーのデフォルトの動作をキャンセルする事でこの問題を解決する事ができました。

### この間のChickenPaintの更新もご確認ください。
2023/11/25 v6.15.9で、ChickenPaintのショートカットキーを追加。
その後発生したバグをv6.15.9.3で修正しています。  

## 2023/11/26 v6.16.0.1
### スレッド個別表示時にスレッドをリロードしやすくするためスレタイに固定リンクのURLをリンク

- 個別スレッド時のスレタイへの個別スレッドの固定リンクを追加しました。
- メインページ同様スレタイをクリックすると、その個別スレッドが表示されます。
- 個別スレッド表示時に、スレタイをクリックするとスレッドをリロードできるようになります。
(テンプレートBASICのみ)

## 2023/11/26 v6.15.9.3
### 更新した独自仕様版のChickenPaintのバグを修正
- ブラシツールを選択しているにも関わらずキャンバスの回転の動作のままになるバグの原因を特定しました。  
キャンバスの回転ツール選択時に｢R+左クリック｣でキャンバスを回転すると、キーを離したあと元のキャンバスの回転ツールが動作しなくなる事に対応するために追加したコードに問題がありました。  
キャンバスが回転したままになるコードを除去しました。  
そのコードを除去しても、キャンバスの回転ツール選択時に｢R+左クリック｣でキャンバスを回転したあと、キーを離すと正常動作する事を確認しました。
R+左クリックへの書き換えが必要なコードが残っていた事がそもそもの原因でした。

## 2023/11/26 v6.15.9.3
### 更新した独自仕様版のChickenPaintのバグを修正
- キャンバスが回転したまま、他のツールが使用できなくなる問題が発生したため、Rキーでキャンバスの回転モードに入る条件を細かく設定しなおしました。  
- また、GitHubのコードスキャンで見つかったブラウザの言語を取得する処理のJavaScriptのコードの脆弱性を修正しました。  

### ChickenPaintのショートカットキーをさらに追加
- エアブラシのショートカットキーを追加しました。

## 2023/11/26 v6.15.9.2
### 独自版のChickenPaintのショートカットキー関連のバグを修正
- v6.15.9からv6.15.9.1のChickenPaintにバグが見つかりました。
お手数をおかけしますが、ChickenPaintの更新をお願いします。  
ツールのキャンバスの回転ボタンを選択中に、新しく追加されたキャンバスの回転のRキー+左クリックを行うと、元のキャンバスの回転のツールボタンが無効になるバグが修正されています。 


## 2023/11/25 v6.15.9.1
### 独自版のChickenPaintの構文エラーを修正
- v6.15.9のChickenPaintがバグっていました。
お手数をおかけしますが、ChickenPaintの更新をお願いします。

## 2023/11/25 v6.15.9
### ChickenPaintのショートカットキーを追加
- 動作しなくなっていたキャンバスの回転のショートカットキーを別のショートカットキーに変更して改修しました。
キャンバスの回転の元のショートカットキーは、｢altキー+スペースキー+左クリック｣でした。この元のショートカットキーを動くようにしても、ブラウザの、｢alt｣を押したあと｢スペース｣でブラウザのメニューが開くため操作を間違えるとタブを閉じてしまいます。  
また、キーを2つ同時に押す必要が発生します。  
そこで、｢Rキー+左クリック｣にショートカットキーを変更して、｢Rキー｣を押している間だけ、キャンバスが回転するようにしました。
- レイヤーの左右反転のショートカットキーを追加しました。  
｢Hキー｣を押すたびに、選択中のレイヤーが左右反転します。
- ツールの切り替えのショートカットキーを2つ追加しました。｢薄消しゴム(Sキー)｣｢水彩(W)｣
｢ソフトイレーサー｣の｢S｣。水彩=Water Colorで、｢W｣です。

## 2023/11/23 v6.15.8
### ChickenPaint更新
- 独自仕様版のChickenPaintを更新しました。

### 個別スレッド表示で画像が複数枚ある時は画像のポップアップ表示をギャラリーモードに
- luminousによる画像のポップアップ表示を個別スレッド表示でかつ画像が複数枚存在する時は、ギャラリーモードで表示します。  
前後の画像を表示する横矢印で画像を順番に表示します。

## 2023/11/18 v6.15.6
### ｢Pale Moon｣｢Waterfox Classic｣といった、Javaプラグインが今でも使用できるブラウザに対応

> [Waterfox Classic | Waterfox Classic](https://classic.waterfox.net/)
> [「Pale Moon」古い「Firefox」の拡張機能も動作する派生版Webブラウザー - 窓の杜](https://forest.watch.impress.co.jp/library/software/palemoon/)
> 

該当ブラウザは上記URLからダウンロード可能です。  
IEとEdgeのIEモードではオラクルのJava8の32bit版を使いますが、｢Waterfox Classic｣と｢Pale Moon｣は64bit版のJava8が必要で、EdgeのIEモードも、｢Waterfox Classic｣と｢Pale Moon｣も使いたい時は、32bit版のJavaと64bit版両方のJavaのインストールが必要です。

この｢Waterfox Classic｣と｢Pale Moon｣でJavaプラグインを使ったしぃペインターを起動する事はできていましたが、投稿に失敗する状態だった事がわかりました。
独自に追加したセキュリティチェックでエラーになっていました。  
この問題を修正して、｢Waterfox Classic｣と｢Pale Moon｣でも、Javaプラグインをつかったしぃペインターからの投稿ができるようにしました。  
Windowsであれば、EdgeのIEモードを使う事でJavaプラグインによる安定した環境でしぃペインターを利用可能でしたが、Macでは、｢Waterfox Classic｣や｢Pale Moon｣を使うしかJavaプラグインを使う方法が存在しないため、対応しました。

> [どうすれば手動でJavaをダウンロードしてWindowsコンピュータにインストールできますか。](https://www.java.com/ja/download/help/windows_manual_download.html)
オラクルのJava8のインストールはここから

![image](https://github.com/satopian/poti-kaini/assets/44894014/5ad121bf-42fe-4640-97e7-45fd39f69161)

インストールしても、例外サイトリストに登録しないと起動しません。

若干不安定ではあるものの、Google ChromeではCheerpJでJavaプラグインを使用しなくてもしぃペインターが起動します。 

また、ネット上で｢しぃペインター｣という用語で呼ばれているレイヤー2枚の｢お絵かきしぃ掲示板 PaintBBS｣は、｢しぃペインター｣ではなく｢PaintBBS｣です。｢PaintBBS｣はHTML+JavaScriptの｢PaintBBS NEO｣へ移行しているため、Javaは必要なく、上記のJava関連の問題とは関係ありません。

### 改善
- しぃペインターから送信された画像の破損チェック機能を追加しました。  
しぃペインター以外のお絵かきアプリにはすでに実装ずみの画像の破損チェックを追加しました。  
画像の破損が確認された場合は、お絵かき画面から移動せず、スクリーンショットの撮影を促すエラーメッセージを出します。  

- PaintBBS NEOではない、古いJavaのPaintBBSからの投稿時に、ツール名が｢Shi-Painter｣になっていたのを｢PaintBBS｣になるように修正しました。  
HTML5版のPaintBBS NEOとは別の古いJavaAppletのPaintBBSから送信されたデータの場合はツール名が｢PaintBBS｣になるようにしました。  
JavaプラグインではPaintBBSからの送信に失敗し、CheerpJv2.3からの送信の場合にも失敗しますが、CheerpJv3では成功するため、古いpchデータをキャンバスに読み込んで送信する事が可能になります。  
その時のツール名が｢PaintBBS｣になるように調整しました。  
CheerpJ のv3は、正式版がでてから対応する予定です。  

## 2023/11/04 v6.12.1
お絵かきアプリから送信されたPNG画像が破損していたら、お絵かき画面から移動せず、スクリーンショットの撮影を促すエラーメッセージを出すようになりました。  

![image](https://github.com/satopian/Petit_Note/assets/44894014/8700850c-ac51-4913-9c8b-2dd394c5d84e)

`ImageCreateFromPNG()`で画像を生成する事ができるかどうかチェックする事で、画像が破損しているかどうかを検出する事に成功しました。  
これにより、画像が破損した状態で投稿され作品が失われる確率をさげる事ができました。  
psdファイルやchiファイル等アプリ固有ファイルのチェックは含まれていません。固有ファイルが破損して、同時に画像を上のレイヤーで隠している場合は、画像の復旧ができませんのでご了承ください。    
破損状況を確認する事ができたのはPNG形式の画像のみです。    


## 2023/11/02 v6.11.10
### Klecks更新
- Klecksを最新版に更新しました。
### 改善
JPEG画像が回転していたり、位置情報がついている事が判明した時の処理が改善されました。
これまでは、回転または位置情報を検出した時には同じサイズのJPEG画像を出力していました。
今回の更新で`MAX_W_PX`や`MAX_H_PX`で指定した値(例えば1024px)で縮小されるようになりました。
これにより、幅と高さが、指定した値を超える時の二度目の画像処理を行わなくてもすむようになります。
JPEG画像を作成して、さらにJPEG画像を作成する処理の無駄と画質の劣化どちらも解決します。

## 2023/10/29 v6.11.5
### バグ修正
- Tegakiのみを使う設定の時にお絵かき機能が有効にならないバグを修正しました。
### CheerpJ v3対応のための準備
- CheerpJ v3で動的パレットの明るさの明+明-が動くようになります。  
しかしながら、掲示板のJavaScriptにも手を加える必要があり、なおかつEdgeのIEモードやFirefox51等でオラクルのJava8を使った時にもパレットを動作させる必要があります。  
それぞれに対応するため処理の追加と振り分けができるようにしました。   
具体的にはJavaScriptの`await`が使用可能かどうかUAから判断して、利用可能な場合は`async`、`await`をJavaScriptに追加します。

### Exifを解析
- Exifを解析して位置情報が検出された時はGDで作成した画像で上書きして位置情報を削除するようにしました。
- Exifに画像の回転情報が入っている時は、画像の向きを修正した新しい画像を作成するようにしました。
これにより例えばスマホの縦長の写真 をアップロードした時に、横長になってしまう問題が解決するかもしれません。

### 大きすぎる画像を適正サイズに

- デジカメ写真や印刷用途の解像度のイラストはWebへのアップロードには適していない場合があります。 
- 今回の更新では、Petit Noteですでに採用ずみの処理を使い、1024px以上の画像を1024px以内に収まるようにします。  
これにより、｢大きな画像はアップロードする前に縮小してください｣とお願いしなくても、自動的に適正サイズに縮小されます。  
ただし、あまりにも過大なファイルサイズの場合はサーバで処理できずアップロードがそもそもできない事が多いので、すべてのケースをカバーできる訳ではありません。

### config.phpに新規設定項目を追加

```
//アップロード時の幅と高さの最大サイズ これ以上は縮小
define("MAX_W_PX", "1024"); //幅
define("MAX_H_PX", "1024"); //高さ
```
添付した画像がこの幅と高さの範囲を超えていたらサムネイルではなく投稿される画像そのもののサイズが範囲内に収まるように縮小されます。
設定項目が存在しない場合は、幅、高さともに1024pxで固定になります。

## 2023/10/24 v6.10.8

mobile判定して、Javaのしぃペインター等のPC用のメニューを非表示にしていたJavaScriptの関数を外部化しました。  
またそのJavaScriptの処理には関数名が必要ないため、アロー関数に置き換えられました。
`potiboard.php`の使用していないコードを削除しました。

テンプレートの更新が多めですが、かならず更新しなくてはならないというわけではなく、できるだけコードを繰り返しかかなくてすむようにするためのコードの整理になります。

テンプレートをカスタマイズしていない方は、`templates/`ディレクトリを上書きすればテンプレートの更新が終わります。

## 2023/10/24 v6.10.7
v6.10.6で、しぃペインターが起動しなくなっていたのを修正しました。

## 2023/10/23 v6.10.6
### Klecks更新
- Klecksを更新しました。
### コード整理
- CheerpJ v3のRC1がリリースされたため、CheerpJ v3にもv2にも対応できるようにペイント画面のJavaScriptを調整しました。
- PNG画像のファイルサイズが一定の容量を超過した時はjpegに変換してファイル容量を縮小する処理を関数化しました。

### PNGからJPEGに変換される条件が変わりました。

```
/アップロードしたPNG画像のファイルサイズが設定値より大きな時はJPEGに変換
//JPEGに変換した画像ともとのPNG画像を比較してファイルサイズが小さなほうを投稿します
//単位kb
define("IMAGE_SIZE", "512");

```
これまでは、お絵かき画像もアップロード画像もここで設定したファイルサイズを超える時はPNGからJPEGに変換していましたが、ここで設定した値の影響を受けるのはアップロード画像だけになりました。  
お絵かき画像は例えば、上記設定の`"512"`kbを超えていてもPNG形式のまま保存されます。

```
//投稿容量制限 KB phpの設定により2Mまで
//PNG形式の画像をJPEGに変換する事でこの制限を回避できる場合はJPEGに変換します
define("MAX_KB", "1000");

```
投稿容量制限を超えてしまい、そのままではエラーになって投稿ができなくなる時は、お絵かき画像も、アップロード画像もPNGからJPEGに変換されます。
変換後投稿可能なファイルサイズに縮小されていればJPEG形式で投稿されます。

## 2023/10/21 v6.10.2
### お絵かきアプリの幅と高さの最小値が設定できるようになりました。
- お絵かきアプリの幅と高さの最低値はこの間300px固定でしたが、100x100pxの絵を描きたいという要望もあり、エンドユーザーの方が自分で改造しているケースがありました。
今回の更新で、幅と高さの最低値をconfig.phpで設定できるようになりました。  
これにより、改造しなくても、100x100pxのサイズも選択可能になります。  
極端な例になりますが、10x10pxの絵も描けます。  
```
//お絵描き最小サイズ（これ以下は強制でこの値
define("PMIN_W", "300");	//幅
define("PMIN_H", "300");	//高さ
```
config.phpのどこでも構いませんので、上記設定項目を追加すれば、最小サイズの幅と高さを設定できます。  
設定項目が存在しない時は、これまで通り最小値が300px固定になります。

- 幅300px以下の時にレイアウトが崩れていたPaintBBS NEOを独自にカスタマイズ
横幅が300px以下でも、操作に支障がでないようにPaintBBS NEOのCSSを調整しました。

![20231021_NEOキャンバスサイズ50px](https://github.com/satopian/poti-kaini/assets/44894014/567ba920-f213-4c7b-8efa-97a9bcafd07a)

これまでは、操作のためのボタンがキャンバスの内側に入り込んでいました。  
ただし、この表示はオリジナルのPaintBBSと異なってしまうため、開発元のリポジトリにはプルリクエストを行わず、POTI-boardとPetit Note用の独自版とします。
といってもCSSを2行追加しただけであとは同じものです。  

### メール通知機能のコードを整理
メール通知機能関連のコードを整理しました。削除できる箇所は削除し、未定義になる可能性のある箇所は未定義にならないように処理し、エスケープが必要な箇所にはエスケープ処理を追加しました。  
メールで通知される記事のURLに投稿時刻のIDを追加して、URLをクリックした時に該当記事までスクロールするようにしました。 

### ChickenPaintを更新
依存関係の脆弱性を修正して、再度ビルドしたChickenPaintを同梱しました。

## 2023/10/17 v6.09.0
### 改善
- レス返信画面の表示処理の高速化を行いました。
省メモリ化のために、すべてのログファイルから必要な行数のみを取得する処理をv6.07.8で追加しました。 
それにより実際に稼働している掲示板での実測値でメモリ消費量を50%削減する事に成功しました。  
その処理でも十分に速度がでていましたが、さらに軽快に動作させるためコードを最適化しました。  
処理に必要な時間が22%短縮されました。 
これは、in_array()を使用せず、配列とキーを反転してから、issetを使うハックによる高速化です。  
- 投稿直後に表示されるスレッドにIDを追加して、投稿した記事の位置までスクロールするようにしました。  
続きを描くからの投稿直後にも個別の投稿の位置までスクロールします。
また検索結果からのリンクにも記事の位置までスクロールするためのIDが入るようになりました。
残念ながら対応できたのは、Template BASICのみです。  
MONOは投稿フォームがスレッドの一番上にあるため、下方向にスクロールすると使いにくくなるからです。 
- JavaScriptを最適化しました。
別タブで開くボタンの場合は二度押し防止のJavaScriptが無効になるように調整しました。 
一度押すと無効になったまま復帰しないからです。

## 2023/10/13 v6.08.0
### 改善
ペイントフォームの外部化と共通化。
parts/ディレクトリにペイントフォームを外部化しました。
1つのファイルを変更するだけで、すべてのペイントフォームに反映されるようになります。
### バグ修正
お絵かきアプリを使用しない設定で、かつ管理者投稿画面ではお絵かきアプリを使う設定の時に、ペイントアプリのキャンバスサイズが表示されなくなるバグを修正しました。

## 2023/10/11 v6.07.11
ChickenPaintを更新しました。

## 2023/10/10 v6.07.10
### セキュリティアップデート
JavaのしぃペインターとPaintBBSの動画ファイルのmime typeチェックを追加しました。

## 2023/10/09 v6.07.9
### ペイントアプリを更新
- Klecksを更新しました。
- ChickenPaintを更新しました。

## 2023/10/03 v6.07.8
### メモリ消費量を50%削減
これまでのPOTI-boardは、返信画面に1件のコメントしか表示しない場合でも、ログファイルに1万発言記録されている時はその1万発言分のデータを読み込んでいました。  
この問題を解決するため、返信画面とカタログ画面を表示する時に、必要な部分のみをログファイルから取得できるようにしました。  
掲示板の返信画面で5MBメモリを消費していた実際に運用している掲示板のメモリ消費量は半分の2.5MBですむようになりました。  
該当の掲示板ではカタログモードの時にも5MBメモリを消費していましたが、2.5MBのメモリ消費量で動作するようになりました。
### tegaki.js の数値入力を改善
独自改造版のtegaki.jsを更新しました。 
ブラシサイズや不透明度の数値による直接入力を改善しました。上矢印キーで数値が上がり、下矢印キーで数値が下がります。

## 2023/10/02 v6.06.1

### お絵かきアプリからの投稿の場合は、画像の重複チェックをしないようにしました
直前の投稿に真っ白な画像が投稿されていると、同じサイズで同じく真っ白な画像が投稿不能になります。 
時々、実際には何時間もかけて描いているのに時間をかけて描いたレイヤーを非表示にして真っ白な画像を途中経過として投稿する人もいます。  
そのような時に、その投稿が｢同じ画像がありました。｣というエラーにならないようにするための措置です。
### アプリ固有ファイルのダウンロードの時に、mime typeをチェックするようにしました。
- アプリ固有ファイルのダウンロードの時に不正なmime typeのファイルが検出された時には、エラーになるように修正しました。

## 2023/10/01 v6.05.2
### セキュリティアップデート
ChickenPaintの`.chi`形式ファイルの受信時の、mime typeチェックが行わていませんでした。   
不正な投稿が成立しないように様々な工夫を凝らしてはいますが、アップデートをお願いします。  
`tmp/`ディレクトリへの不正なファイルのアップロードが成立する可能性があります。
不正なmimeタイプのファイルは移動前にmime typeがチェックされているため`src/`ディレクトリに移動する事はありません。 
拡張子はプログラム側で`.chi`固定になっています。不正なファイルの拡張子が`.php`や、`.cgi`、`.exe`などになる事もありません。  

### 返信画面下段の前後の画像の表示を改善しました
返信画面下段の6つ並んでいる前後のスレッドの画像の表示を改善しました。  
表示しているスレッドの位置にもよりますが、現在のスレッドより手前の3つと現在のスレッドより後ろの3つに分割しました。  
表示するときに、3枚+3枚で合計6枚の現在のスレッドの前後の画像を表示します。  
現在の位置より手前の画像が3枚存在しない場合は、現在の画像より後ろの6枚を表示して、可能な限り、6枚の画像がならぶように調整しました。  

## 2023/09/21 v6.03.0

### 改善

- ChickenPaintの送信処理を古いxhrからfetch APIに書き直しました。  
(PaintBBS NEO、Tegaki、klecksはすでにfetch APIを使って送信しています)
- 新規投稿の時も返信の時も投稿完了後に該当スレッドを表示するようにしました。
これまでは、新規投稿時は掲示板のトップを、返信の時は該当スレッドが表示されていました。 

### バグ修正
 ペイント画面で入力したものをそのままツール名としてログファイルに記録していました。  
仮に不正な文字列が入力された場合でも、ログファイルのバージョンが6ではなく5として扱われるだけの被害にとどまるとは思いますが、バリデーションをほどこして、予想されるツール名以外のツール名が入力された時は空白を記録するようにしました。  
出力時のバリデーションはすでに実施ずみでした。  
また、ツール名にJavascriptが含まれている場合でも、テンプレートの出力時にHTMLの特殊文字はエスケープしていますので、xssなどのリスクはここには存在しません。  

### テンプレートのWeb StyleをTemplateに変更

Web Style by BASICという表記はオリジナルのPOTI-boardを踏襲したものでしたが、英語圏ではbyに続く文字は作者名の事が多い事が多いため、Template BASICのような形式で記載する事にしました。 

## 2023/09/11 v6.01.7

- search.inc.phpに、2286年問題が残っていたのを修正。(160年後の誤動作防止)
- ページングの最初のページと最後のページが表示できるようになりました。｢最後｣をクリックすると一番古い投稿を表示します。
- カタログモードの時に1ページに表示する画像の枚数が30枚で固定になっていたのを設定可能に。

## 2023/09/10 v6.00.10

- ユーザーエージェントの無いブラウザ以外からのアクセスの時に軽微なエラーが発生していたのを修正。
- 描画アニメファイルの拡張子チェックをする前に存在するかどうか確認して負荷を削減。
- 描画時間の文字列が折り返しになってしまうのを修正(テンプレートBASIC)
- 検索画面の最終更新日の計算箇所が、2286年問題に対応していなかったのを修正。

## 2023/08/31 v6.00.7
### 使用ツール名の表記の修正
- shi-Painter→Shi-Painter

## 2023/08/30 v6.00.6
### バグ修正
- アップロード投稿時に｢Tool:Upload｣と表示されないバグを修正しました。

## 2023/08/28 v6.00.5
### ログファイルを拡張しました
- 使用したペイントツールの名称が表示されるようになりました。
- 2286年問題に対応。ユニックスタイムスタンプが11桁になっても正常に動作するようにしました。
(現実問題としては、2286年になる前にシステムが動かなくなっている可能性のほうが高いです。11桁になるのは263年後です。)
- 動画ファイルの種類、サムネイルの有り無しがログファイルに記録されるようになりました。これにより、毎回ファイルの存在確認をしなくてもよくなるため負荷を下げる事ができます。  

このver6.0用に作成されたログファイルは、ver1から、ver5までのすべてのPOTI-boardで使用できます。  
ver6.0で新たに追加されたログファイルの情報は古いPOTI-boardでは読み込む事ができませんが、古いバージョンのPOTI-boardでは新しく追加された情報を無視して動作します。

ログファイルの変換の必要もなく、ver6.0以後のPOTI-boardを使用した時には、新しい情報が追加され、古いログファイルにはその情報が存在しないだけです。   

### バグ修正
- テンプレートMONO使用時に、続きを描く画面で｢Tegaki｣が選択できなくなっていたのを修正しました。 
- 続きを描く画面で余分な波括弧が表示されていたのを修正しました。
- 検索画面で次ページのリンクが正しく動作していなかったのを修正しました。

## 23/08/13 v5.63.8
### 管理者モードのリンクを非表示にする設定項目を追加しました。
#### config.phpに以下の設定項目を追加しました。

```
//管理画面へのリンクを表示する する:1 しない:0
define("USE_ADMIN_LINK", "1");
//しない:0 で、管理画面へのリンクが表示されなくなります。
```
設定項目が存在しない場合は、従来と同じ動作になり、管理画面へのリンクが表示されます。

## 23/08/07 v5.63.7
### Klecks更新
非表示レイヤーの色がスポイトされる問題が修正されました。

## 23/08/04 v5.63.6.1
### KlecksとTegakiの更新
- klecks/ ディレクトリを上書きアップデート
- tegaki/ ディレクトリを上書きアップデート

## 23/07/27 v5.63.6
### バグ修正
- EdgeのIEモードで表示できなくなっていたのを修正しました。

## 23/07/27 v5.63.5
### 変更があったファイル
- potiboard.php
- search.inc.php
(変数が未定義になっていた箇所を修正)
### 変更があったテンプレート
#### BASIC
- templates/basic/paint_tegaki.blade.php
(tegaki.js使用時のiPadのダブルタップズームを回避)
#### MONO
- templates/mono/mono_main.blade.php
(searchのリンクがsearch.phpのままになっている箇所があったのを修正)
- templates/mono/paint_tegaki.blade.php
(tegaki.js使用時のiPadのダブルタップズームを回避)

## 23/07/13 v5.63.3

### SNS共有時に開くWindowsの幅と高さをconfig.phpで設定できるようにしました。
config.phpに新規設定項目を追加しました。

```

// SNS共有の時に開くWindowsの幅と高さ

//windowの幅 初期値 350
define("SNS_WINDOW_WIDTH","350");

//windowの高さ 初期値 490
define("SNS_WINDOW_HEIGHT","490");

```

SNS共有時のサーバ一を追加した時に、共有画面のWindowの高さが不足して、スクロールする必要があるケースがありました。
SNS共有時のサーバ一覧の共有画面のWindowsの幅と高さを設定できるようにして、その問題を解決しました。
上記設定項目がconfig.phpに存在しない時は、デフォルト値の、幅350px、高さ490pxが適用されます。

## [2023/07/11] v5.63.2
### 投稿を共有するSNSのサーバ一覧画面の操作性を向上
共有するサーバの選択時にラベルの文字列の上にカーソルをあわせなくても選択できるようにしました。  
ラベルの文字列の右側の余白をタップした時にも選択できるうようになりました。
- set_share_server.blade.php
のHTMLの文法エラーを修正しました。

![image](https://github.com/satopian/poti-kaini/assets/44894014/b6a5d020-9614-4b04-bc34-077fe694a12c)

## [2023/07/11] v5.63.1
### 検索処理をsearch.phpからsearch.inc.phpへ
jQueryのバージョン設定やその他の関数がpotiboard.phpとは別に設定されていたsearch.phpの構造を根本から見直して、potiboard.phpにincludeするclassに修正しました。
検索結果は、これまでは`search.php?`のようなURLで表示されていましたが`potiboard.php?mode=search&`のようなURLに変わります。
### テンプレートMONOのCSS切り替え箇所を外部化して共通化
`templates/mono/parts/style-switcher.blade.php`にこれまでいくつものテンプレートに記述していた以下の箇所をまとめました。

```
<style>
body{
	visibility: hidden;
}
</style>
<noscript>
	<style>
		body{
			visibility: visible;
		}
	</style>
</noscript>
<link rel="stylesheet" href="{{$skindir}}css/mono_main.css?{{$ver}}">
<link rel="stylesheet" href="{{$skindir}}css/mono_dark.css?{{$ver}}" id="css1" disabled>
<link rel="stylesheet" href="{{$skindir}}css/mono_deep.css?{{$ver}}" id="css2" disabled>
<link rel="stylesheet" href="{{$skindir}}css/mono_mayo.css?{{$ver}}" id="css3" disabled>

```
また、ここに`visibility: hidden;`というCSSを設定してDOMの読み込みとJavaScriptの読み込みが完了するまで画面を表示しないようにしました。 
これにより、MONOの色設定が一瞬別の配色で表示されるのを防ぎます。

### 検索で、大文字小文字を区別しない

名前検索で完全一致オプションの時に、アルファベットの大文字小文字を区別しなくなりました。

## [2023/07/08] v5.62.3

###  投稿をシェアするサーバの一覧画面のデザインを調整しました。

![image](https://github.com/satopian/poti-kaini/assets/44894014/99b16d04-dd66-436f-b530-e8cf94a4706e)

テンプレート BASICの共有画面を調整しました。  
ラジオボタンのチェックサークルを非表示にしました。  
選択済みの時のラベルの文字を太字にしました。  

## [2023/07/08] v5.62.2
### バグ修正
検索機能が動かなくなっていました。
このバグは、v5.58.10で発生し、v5.62.2で修正されました。

### ツーイートボタンから｢Twitter｣｢Mastodon｣｢Misskey｣共有へ。

｢Twitter｣以外の、｢Mastodon｣｢Misskey｣等の短文投稿SNSに投稿を共有できるようにしました。

![image](https://github.com/satopian/poti-kaini/assets/44894014/61678d34-fc91-47fa-b18c-a39604a755a9)

config.phpで設定すれば以前のツイートボタンに戻す事もできます。  
また、共有するMastodon、Misskeyのサーバ一覧を編集する事もできます。

## [2023/06/24] v5.61.2
### tegaki.jsが使えるようになりました。
英語圏最大の画像掲示板で使われているお絵かきアプリ｢tegaki.js｣に対応しました。  
現時点では、続きを描くと描画アニメは消えてしまいます。
(NEOの画像から続きを描くと同じ)

![230621_tegaki_sukumizu_001](https://github.com/satopian/Petit_Note/assets/44894014/02a75d17-f94a-4e6b-8ec3-8e762d26713e)

### ChickenPaintの独自修正版を同梱しました。

非推奨のJavaScript、jQueryの構文を独自に修正したものを同梱しました。  

### 投稿者名をコピー機能を改善

投稿者名をコピーボタンを押したときに、テキストカーソルの位置に名前が挿入されるようになりました。  
これまではテキストフィールドの文末に追加されていました。

## [2023/06/11] v5.60.0
### ペイントアプリの非推奨になったJavaScriptを修正
- PaintBBS NEOをv1.6.0に更新しました。独自拡張版として運用していたバージョンを開発元にマージしていただく事ができました。
- ChickenPaintの独自修正版を同梱しました。

### Klecksがレイヤー二枚で起動するようになりました。

![image](https://github.com/satopian/poti-kaini/assets/44894014/23eec76c-969a-458b-931a-2c3bb56e9201)

## [2023/05/20] v5.59.0
### バグ修正
- Tweetボタンを押した時に記事の固定リンクのURLが正しくセットされなくなっていたのを修正しました。
- このバグはv5.58.6で発生し、v5.59.0で修正されました。

### jQuery更新 
- jQueryをjQuery3.6.0からjQuery3.7.0に更新しました。
- jQueryのバージョン管理はpotiboard.phpの内部で行っているため、個別のテンプレートの修正は必要ありません。
### 非推奨になったJavaScriptとjQueryの構文を修正しました
- templates/basic/js/basic_common.js
- templates/mono/js/mono_common.js  
各ファイルの非推奨になったJavaScriptとjQueryの構文を修正しました。

## [2023/05/07] v5.58.9.1
- Klecks更新
- BladeOne更新
- テンプレート内の非推奨になったjQueryの構文を修正

## [2023/05/03] v5.58.9
- klecks更新

## [2023/04/25] v5.58.8
### chickenpaint更新
chickenpaintをiPadのフルスクリーンモード、あるいはiPhoneで使用した時に、パレットメニューが画面外に出る、描画領域の縦横比が縦に伸びる、横に伸びるなどの問題が発生していました。  
フルスクリーンモードの時のスタイルシートが原因でした。ただしこれは、iPad、iPhoneの時にのみ発生する問題です。
逆にいうと、PC+Chromeで問題が発生していなくても、iPadユーザーがChickenPaintを使用する時にはトラブルが発生していたということです。
v5.58.8と、控えめなバージョン番号の差ですが、`chickenpaint/`ディレクトリの上書きアップデートのみでも構いませんので、更新をご検討ください。
現時点では開発元での修正はまだ行われておらず、これは独自修正版です。

プルリクエストを行い、開発元にこれを統合するかどうかの判断をお願いしているところです。
https://github.com/thenickdude/chickenpaint/pull/52

## [2023/04/13] v5.58.5

### ChickenPaint更新 
- iPadでデバイスの向きを変更すると描画領域のアスペクト比が壊れる問題に対応するため、ChickenPaintを独自にカスタマイズしてビルドしたバージョンのものを同梱しました。(問題が解決するまでの暫定措置)
- この問題はChickenPaintをフルスクリーンモードで使用している時にだけ発生します。
- そのためフルスクリーンモードでの起動をとりやめて通常モードで起動するようにしました。
ChickenPaintのメニューバーからフルスクリーンモードを選択すればフルスクリーンモードへの表示の切り替えは可能です。

### 改善

#### PaintBBS NEOの動的パレットの非推奨になったJavaScriptを修正

- WCS動的パレットスクリプトのsubstr()をsubstring()に書き直しました。
[String.prototype.substr() - JavaScript | MDN](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/String/substr) MDN

#### 続きを描く→新規投稿の時に同じスレッドに投稿するかどうかを選択可能に  
古いバージョンでは、続きを描く→新規投稿を選択すると新しいスレッドへの投稿になっていました。   
たとえば1枚の線画の塗り絵を10名が行う時に10スレッド必要でした。  
これを1つのスレッドにまとめる事ができるようになります。  

また返信として投稿されたお絵かき画像からの続きを描く時には、同じスレッドへの投稿になるようにしていましたが、こちらも返信からの新規投稿を新しいスレッドに投稿したい場合があり、自由に選択できるようにするべきという結論に達しました。 

![230307_続きを描く_同じスレッドに投稿する](https://user-images.githubusercontent.com/44894014/223247562-6184578c-3565-4f43-8a10-2feedd5e46b1.gif)
 
その選択のために｢同じスレッドに投稿する｣というチェックボックスを追加しました。  
しかし｢画像差し換え｣の場合は同じスレッドに投稿するより他ないためこの選択肢は不要です。  
  
そこで、JavaScriptを使って、新規投稿を選択した時のみ｢同じスレッドに投稿する｣というチェックボックスを表示するようにしました。

#### ホスト名が逆引きできずIPアドレスになる時の拒絶処理を修正

ホスト名で拒絶する時の一般的な例は後方一致です。  

> example.com

のように後ろの方が一致する部分を拒絶します。
しかし、IPアドレスの場合は前方一致で拒絶する必要があります。  
 
ホスト名が取得出来ないIPアドレスからの投稿の時はホスト名にIPアドレスが表示されますが、IPアドレスの拒絶処理も後方一致になってしまい拒絶不能になっていました。

そこで、ホスト名とIPアドレスが同じユーザーの時は、ホスト名として表示されているIPアドレスの前から数文字分を指定して前方一致で拒絶できるようにしました。  

>$badhost =["example.com","100.100.200"];

このように設定した場合、

"example.com"は後方一致で拒絶処理が行われ、"100.100.200"は前方一致で拒絶処理が行われます。

## [2023/02/26] v5.56.3

### Klecksを最新版にアップデート

![image](https://user-images.githubusercontent.com/44894014/221393538-22d0a2b5-d725-4bc9-9e97-7dd7e15fdf3b.png)

- ダークテーマが選択可能になりました。  
- フランス語に対応しました。
- iPhone、iPadのタッチジェスチャーでフリーズする問題が修正されました。

### BladeOneを最新版にアップデート
- BladeOneをv4.8に更新しました。
### 改善
- 検索画面の並び方が、最新順にならないケースがあったのを修正しました。
- 検索画面のコードを改善しました。

## [2023/02/11] v5.56.2.3
### バグ修正
サーバのステータスが｢502 Bad Gateway｣の時に描いていた絵が消えてしまうバグを修正しました。  
サーバのステータスが200以外の時には｢投稿に失敗時間を置いて再度投稿してください｣というアラートを表示するのみで、画面を推移しないようにしました。 画面を推移しないので、スクショを取る事が可能になります。また、ほとんどの場合、再度投稿ボタン押せば投稿に成功します。

## [2023/02/09] v5.56.2.2
- 入れ忘れていたklecksのヘルプファイルを追加しました。  
`klecks/`フォルダをアップデート、または、`klecks/help.html`を個別にアップロードします。

## [2023/01/19] v5.56.2
###  config.phpで、URLの入力欄を使用するしないを設定できるようになりました。

```
//URL入力欄を使用する する:1 しない:0
define("USE_URL_INPUT_FIELD", "1");
//しない:0 で、フォームの入力欄からURL欄が消えます。
//フォームを偽装してもURLの入力ができなくなります。

```
本文へのURLの書き込み禁止にあわせて、URL欄へのURLの記入もできなくすれば、URLを書き込む事が目的の広告スパムを排除する事ができます。  
本文へのURL書き込み禁止のURL判定はかなり厳しい条件になっているため、例えば`http://`を省略しても広告スパムのURLを書き込む事はほぼできない筈です。

### テンプレートにURL欄や題名欄が存在しない時にJavaScriptのエラーで送信できなくなる問題を修正しました。
これはバグではないのですが、ユーザーによるテンプレートの修正があった場合でも正常に動作するようにJavaScriptを書きなおしました。

### PaintBBS NEOでコピー、レイヤー結合などキャンバス周辺を含む操作で画面が上下に動かないようにする工夫
コピーやレイヤー結合などの時にキャンバス周辺の紫の網目のところをスワイプしても画面が上下に動かなくする工夫を行っていましたが、その事が原因でモバイル端末で操作不能になるケースもありました。
今回の更新で、開いたキャンバスサイズの幅に対して端末の横幅に余裕がある時だけ、NEOのキャンバスの周囲の網目のところでスワイプしない形に変更になりました。
NEOの網目のところをつかんでスクロールできるようにしておかなければ操作不能になるからです。
キャンバスサイズと比較して、端末の横幅に余裕がある時は、NEOの網目のところをつかんでもスクロールしなくなります。
コピーやレイヤー結合、Bz曲線の操作の時に画面が上下に動いてしまうからです。

また、ピンチズームで拡大している時も網目のところをつかんでスクロールできるようになりました。
操作不能になるのを回避するためです。
これらは、NEOのペイント画面のインラインのJavaScriptで実装していますので、ペイント画面のテンプレートの更新が必要です。

![NEO_issue_230201](https://user-images.githubusercontent.com/44894014/216770678-0e5ab56d-89fa-4f39-8d72-0c71c2b022de.gif)


## [2023/01/19] v5.55.8.5
### バグ修正
- PHP8.1、PHP8.2ではエラーが発生しないため見落としてしまっていた`saveneo.php`の大きなバグを修正しました。

PHP5.6-PHP7.x環境で、PaintBBS NEOのデータの受信がまったくできなくなっていました。これは、古いバージョンのPHPでは致命的エラーになる書き方をしてしまっていたためです。  
saveneo.phpの上書きアップデートをお願いします。

## [2023/01/14] v5.55.8.2

### バグ修正

> //セキュリティタイマー(単位:秒)。設定しないなら""で
> define("SECURITY_TIMER", "");
> 
で、描画に必要な最低秒数が設定されているときに、本来であれば｢あと15秒｣のように表示されるべきアラートの表示が、すべて｢あと0秒｣になるバグを修正しました。  
例えばこのバグがある状態でも60秒で設定していれば、60秒を超えていれば普通に投稿できます。
しかし、残り時間は正確に表示されず、すべて｢あと0秒｣になっていました。

## [2023/01/14] v5.55.8.1
- saveneo.phpのバグを修正しました。
昨日追加したばかりの新しいNEOの受信PHPスクリプト、saveneo.phpのバグを修正しました。  

不正画像検出時のエラー、対応ブラウザでは無かった時のエラーの時に、お絵かき画面にアラートが開いてエラーメッセージを知らせる箇所にバグがありました。  
上記該当エラー発生時に、描いている絵の画面から画面が推移してしまい投稿画像が消えてしまうバグを修正しました。  

## [2023/01/13] v5.55.8

### WAFによる誤検知のエラーを回避するためPaintBBS NEOの通信を生データからformDataに変更しました
- 従来のお絵かき掲示板に投稿できるようにするために、生データを送信していたNEOを改造して、formDataでヘッダ、画像、動画データを送信できるようにしました。
この変更によって、従来のWAFがNEOの送信データを攻撃と判断して遮断する確率が低くなり投稿が成功する確率が飛躍的に高くなります。  
NEOはこれまで生データを古い掲示板との互換性を確保するために送信してきました。今回の独自拡張でによってそれが、formDataに変わります。
現時点では独自規格ですが規格が乱立するのはよくない事ですので、開発元にプルリクエストを出しています。  

#### 重要な変更点

- しぃペインターのデータの受信はこれまで通り、`picpost.php`で行います。  
しかし、PaintBBS NEOのデータの受信は、新しく追加した、`saveneo.php`で行います。  
このファイルのアップロードを忘れると、NEOからの投稿ができなくなりますので、必ずアップデートしてください。  
potiboard.phpと同じディレクトリに転送します。
- Paint画面のテンプレートの更新
```
mono_paint.blade.php  
paint.blade.php  

```
の更新をお願いします。
formDataで送信するモードに切り替えるためのパラメータが追加されています。
ここで重要なのは、neo.jsがブラウザによってキャッシュされている場合です。  
新しいバージョンのneo.jsがブラウザに読み込まれる前に、その他のファイルが更新された時は、saveneo.phpによる受信に失敗します。

### 使用するお絵かアプリの設定方法

> //PaintBBS NEOを使う 使う:1 使わない:0 
> define("USE_PAINTBBS_NEO", "1");
> //しぃペインターを使う 使う:1 使わない:0 
> define("USE_SHI_PAINTER", "1");
> //ChickenPaintを使う 使う:1 使わない:0 
> define("USE_CHICKENPAINT", "1");
> //klecksを使う 使う:1 使わない:0 
> define("USE_KLECKS", "1");
> //管理者は設定に関わらすべてのアプリを使用できるようにする する:1 しない:0
> define('ALLOW_ADMINS_TO_USE_ALL_APPS_REGARDLESS_OF_SETTINGS', '1');
> 

これまでは、PaintBBS NEOを使用するアプリから外す事ができませんでしたが、NEOを使う使わないも選択可能になりました。  
すべて使わないに設定すると、お絵かき機能を使用しない設定になります。  
Klecksだけ使う、ChickenPaintだけ使う設定にする事もできます。
使用するアプリが1つしか無い時はアプリ選択のプルダウンメニューが消えてすっきりした画面になります。    

### 描画時間による制限

たとえば1分以下で描いた線だけの投稿は拒絶したい時は、

```
//セキュリティタイマー(単位:秒)。設定しないなら""で
define("SECURITY_TIMER", "");

```
で必要最低限の描画時間を指定する事ができましたが、これまでは、しぃペインターと、PaintBBS NEOにのみ有効でした。  
今回の更新で、ChickenPaintやKlecksでもこの設定が有効になるようになりました。  
古い方式では、違反の時は別のサイトに飛ばす(例えば警視庁のサイト)がありましたが、その方式ではなく、｢描画時間が短すぎます。あと30秒。｣といった内容のアラートが開きます。  

## [2022/12/30] v5.52.8

### Javaのpchデータから幅と高さを取り出す事ができるようになりました

管理画面からのpchファイルのアップロードがより簡単になりました。  
v5.22.2で、HTML5版のPaintBBS NEOのpchファイルとしぃペインターのspchファイルをアップロードした時に、自動的にキャンバスサイズがセットされるようになりました。  

これまでは、Java版のPaintBBSのpchファイルの幅と高さは自動的に計算されず、例えばキャンバスサイズが500x500の時にそれよりも小さな画像のpch(アニメデータファイル)をアップロードすると、キャンバスの周囲に余白ができる事がありました。  
この時に、塗りつぶしなどの操作が含まれている場合は、本来塗りつぶす筈ではない箇所が塗りつぶされる事もありました。  
今回の更新で、HTML5版、Java版ともにpchデータから幅と高さを取り出す事ができるようになり、この問題を解決する事ができました。  

![221227_006](https://user-images.githubusercontent.com/44894014/210074911-42c0ae95-3ccb-419f-9797-a9ad38588c42.gif)  
↑    
pchデータとキャンバスサイズが一致していない時と一致している時を比較。 
一致している画面は今回の更新でpchデータから幅と高さを取得したもの。  

しかしながら、CheerpJアプレットランナーの最新版では、Java版のPaintBBSからの投稿ができなくなっていますので、実質、pchデータをキャンバスに読み込んで画像化するところまでしかできなくなっています。  
Javaアプレットからの投稿はすべて受け付けなくなっている訳ではなく同じくCheerpJで起動したしぃペインターからの投稿も、オラクルのJavaで起動したしぃペインターからの投稿も可能です。
EdgeのIEモードでJavaを使用すれば2023年の環境でしぃペインターを安定的に使う事ができます。  

ただし、オラクルのJava8をインストールして、使用するサイトをセキュリティの例外に追加する必要がありますので、少しだけ面倒です。  

![image](https://user-images.githubusercontent.com/44894014/210075639-8908cd75-be38-4808-b0cd-9ce5e90097ab.png)  
↑    
Javaを使用するサイトを例外リストに追加すればそのサイトでJavaが起動します。  

## [2022/12/28] v5.52.2

### PaintBBS NEOの動画ファイルのアップロードペイントが簡単に
- PaintBBS NEOとJavaのしぃペインターの動画の管理者画面からのアップロードペイントがより簡単･便利になりました。  
これまで動画ファイルをキャンバスに読み込む前にキャンバスサイズを指定する必要がありました。  
v5.52で、動画ファイルからキャンバスサイズを自動的に取得できるようになりました。  
ただし、Java版のPaintBBSの動画ファイルのアップロード時にはキャンバスサイズの指定が必要です。  
HTML5版のPaintBBS NEOの動画ファイルのアップロード時のキャンバスサイズは自動取得できます。  

![221227_005](https://user-images.githubusercontent.com/44894014/209773098-d83a702f-dd79-49e8-9030-c2cdedee266b.gif)
↑  
これは、しぃペインター、PaintBBS NEO、Klecks、ChickenPaintそれぞれの固有形式のファイルを管理者画面からアップロードした時の動作を紹介するために制作したGIFアニメです。  
キャンバスサイズは300x300のままですが、本来のサイズでキャンバスが開いています。  
PSDファイルのダウンロードができるのならアップロードは?と疑問に感じていた方への説明の意味も含めて、ChickenPaintの`.chi`ファイルと、Klecksの`.psd`ファイル(Photoshop形式)のアップロードも行い動画に記録しました。  

## [2022/12/24] v5.51.0
- PaintBBS NEO 更新 v1.5.16
- WAF（ウェブアプリケーションファイアウォール)をオンにすると、JavaScriptでCookieを読み込めなくなる問題に対応しました。
WAFをオンにするとCookieが、暗号化され、httpOnly属性が付きます。
POTI-boardでは静的HTMLファイルへのJavaScriptによるCookieのロードを行っています。
そのため、従来のPOTI-boardではWAFをオンにするとフォーム入力内容のCookieを読み込む事ができませんでした。
フォーム入力内容のCookieをPHPプログラムによる発行に加え、JavaScriptでも発行することでこの問題を解決しました。  
もっとも、JavaScriptでCookieを読み込む事ができないようにするhttpOnlyのCookieを使ったほうが安全性は高くなりますので、httpOnlyのCookieを使ったお絵かき掲示板を使いたい方は、[Petit Note](https://github.com/satopian/Petit_Note)の利用をご検討ください。  
POTI-boardからのログの変換も可能です。
[satopian/PetitNote_plugin: お絵かき掲示板 Petit Note のプラグイン](https://github.com/satopian/PetitNote_plugin)

- フォーム入力内容のCookieを発行するJavaScriptをHTMLファイルに入れるとインラインのJavaScriptの行数が多くなってしまうため、外部化しました。
そこには、スクロールすると出てくる上に戻るボタンやLuminousのポップアップ表示のためのJavaScriptも入っています。
たびたびテンプレートの更新が必要になってしまいお手数をおかけしますがよろしくお願いします。  
`templates/basic/js/` のような、JavaScript用のディレクトリもできました。  
このディレクトリのアップロードを忘れると、スクロールするとでてくる上に戻るボタンや、画像をクリックすると同じ画面にポップアップするJavaScriptなどが動作しなくなりますので、ご注意ください。
たくさん注意事項を書きましたがテンプレートをカスタマイズしていない方は、`templates/`ディレクトリをすべて上書きするだけです。
新規設置の方もすべてアップロードするだけです。


## [2022/12/21] v5.50.11

### 改善

- XSS対策のためキャンバスサイズのプルダウンメニュー式生成のループの書式を変更しました。
- [W3C  Markup Validation Service](https://validator.w3.org/)によるチェックで警告がでるため、自己終了タグを撤去。
- same-originチェックを追加。別Orijinからの不正な投稿を拒絶するようにしました。
ただしEdgeのIEモード等、Orijinヘッダ非対応ブラウザの場合は、Orijinヘッダのチェックを行いません。
このチェックが必須になると、Javaを使ったしぃペインター起動ができなくなるからです。
たとえば、CheerpJでは、しぃペインターの描画アニメをスムーズに再生する事ができないため、Javaを起動する必要があります。
- 導入が可能な箇所にpost時のCookieチェックを追加しました。  
- ディレクトリトラバーサル攻撃からの防御。fopen()に変数が入る時は、basename()で`../../`などの階層を無効化。
- パスワードを5回連続して間違えた時は拒絶。
管理者パスワードを5回連続して間違えた時はそれ以上入力できないように拒絶する事ができるようになりました。  
この機能を使いたい方は、config.phpのどの場所でも構いませんので以下の設定項目を追加してご利用ください。

>  // 管理者パスワードを5回連続して間違えた時は拒絶する
>  // する: 1 しない: 0
>  // する: 1 にするとセキュリティは高まりますが、ログインページがロックされた時の解除に手間がかかります。
>  
> define("CHECK_PASSWORD_INPUT_ERROR_COUNT", "0");
>  
>  //ftp等でアクセスして、
>  // `templates/errorlog/error.log`
>  // を削除すると、再度ログインできるようになります。
>  //このファイルには、間違った管理者パスワードを入力したクライアントのIPアドレスが保存されています。
> 

- IPアドレス、ホスト名の取得方法を変更。getenv()が使えないサーバに対応しました。
- user-code repcodeの発行にuniqid()を使用。マイクロタイム単位で変化するようになりました。
- リプレースコードの文字数を8文字から12文字に増やしました。

- PaintBBS NEOにWAF誤検知時のエラーメッセージを独自に追加しました。

![Screen-2022-12-21_14-35-27](https://user-images.githubusercontent.com/44894014/208904402-273e7b6c-395d-4c57-a15c-c5614bccc4c1.png)

このエラーメッセージの表示については開発者であるfunigeさんのRepositoryにプルリクエスト中ですが、正式版が今後どうなるのかはまだわかりません。
WAFをオフにするとセキュリティが脆弱になり、WAFをオンにすると、NEOの投稿が失敗する事があるという状況にありますが、WAFによる誤検知だとわかれば、少し加筆すると攻撃とみなされるパターンではなくなる事がほとんどのため、このエラーメッセージに従っていただければ投稿できるようになると思います。  

## [2022/11/30] v5.36.6
### 更新
- klecksを更新しました。  
ブラシのショートカットキーの動作が修正されています。  
- BladeOneをv4.7.1に更新しました。

### 改善

- 投稿時刻の重複を回避。  
作業ファイルで使用しているタイムスタンプが重複している時にも投稿時刻を1秒未来へ進めてタイムスタンプの重複を回避。  
これまでは、作業ファイルが別のファイルで上書きされる可能性がありました。
- 比較対象の投稿時刻が未来の時はエラーにしない。  
投稿の待ち時間の計算処理の時に現在時刻よりも未来の投稿時刻が検出された時は、エラーにならないようにしました。  
例えば、なんらかのミスで投稿時刻が1年後になっていた時は、1年経過しないと次の投稿ができなくなるため待ち時間が負の値の時にはエラーにせず通過するようにしました。
- BladeOne v4.7.1。それにともないキャッシュディレクトリの自動生成を`potiboard.php`で行う形に変更。  
BladeOneからキャッシュディレクトリの自動生成機能が削除されました。それに代わる機能として`potiboard.php`にキャッシュディレクトリ自動作成機能を追加しました。キャッシュディレクトリのパーミッションはこれまでBladeOne側の指定で`0777(777)`でしたが、今回の変更で`0707(707)`になりました。`0777(777)`では動作しないサーバでも動作するようになりました。  

- 書き込みが必要なファイルのパーミッションを事前に`0606(606)`に変更。外部表示不可のログファイルは`0600(600)`。
ログ変換したファイルをアップロードすると、`potiboard.php`が生成したHTMLファイル、画像ファイル、ログファイルのパーミッションは自動的に変更されないままでした。  
今回の変更でログファイルやHTMLファイル、そして画像ファイルのパーミッションがある程度自動的に設定できるようになります。  
たとえば画像ファイルを削除する処理をする直前に`0606(606)`に変更して削除できるようにしたり記事の書き込み時にログファイルを`0600(600)`に変更して、ログファイルを外部から呼び出せないようにします。  

- PaintBBS NEOで投稿に失敗した時のユーザーコード不一致の時のエラーメッセージを追加。
PaintBBS NEOのユーザーコード不一致の時のエラーメッセージを追加しました。  
ユーザーコードが一致しない時は｢時間をおいて再度投稿してみてください。｣というエラーメッセージは適切ではなく、時間をおいても投稿不能だからです。

- Klecksで投稿に失敗した時のエラーメッセージを追加。
サーバのステータスが200以外の時にはエラーメッセージのアラートが開くようになりました。  
サーバがダウンしていたり、通信回線が切断されている時にもエラーメッセージが表示されるようになりました。  

## [2022/10/29] v5.35.3

### 改善
#### テンプレート共通
- 管理画面の画像ファイルをクリックした時にluminousでポップアップ表示するようになりました。  
これまでは画像が別タブで開かれていました。
- 従来の記述では出力するHTMLタグがスクリプト本体にありテンプレートではエスケープする事ができなかった箇所を修正。HTMLパートをテンプレートに移動。出力する値のエスケープをテンプレートで行う事ができるようにしました。  
- tweetをTweetに修正しました。
- TOOLをToolに修正しました。

#### テンプレートMONO
- テンプレートMONOにスクロールすると出てくる上に戻るリンクを追加しました。
- スマホ表示を最適化しました。iPad(768px)以下の解像度の時は画像のfloatを解除。画像のマージンを0に。  
これにより、スマホ表示時の画像の左右の余白が同じになります。  
これまでは、画面右側の余白が大きくなっていました。
- MONOの管理者削除画面でも、番号をクリックすると管理人による記事の編集ができるようになりました。  

### セキュリティ

- CheerpJ Applet Runner のスクリプトの中身がハッキング等によって改ざんされた時にはそれを検知してスクリプトが実行されないようにしました。
[サブリソース完全性](https://developer.mozilla.org/ja/docs/Web/Security/Subresource_Integrity)参考MDN。
この技術は、jQueryをCDNで利用する場合にも活用されているものですが、CheerpJのスクリプトのハッシュ値が公開されているわけではありませんので、Linuxのコマンドを使ってハッシュ値を独自に生成しました。  
CheerpJのバージョンを変更した時には、ハッシュ値も変更しなければ動かなくなります。  
しかしながら、計算ずみのハッシュ値はpotiboard.phpの最新バージョンに開発時に入りますので、エンドユーザーがハッシュ値を意識する必要はありません。
- しぃアプレットや、PaintBBS NEOのデータを受信しているpicpost.phpで受信した画像部分のファイルがjpeg、png等の画像ではなかった時は不正を検知してファイルを削除するようにしました。

### しぃアプレット、PaintBBS NEOの描画に必要な時間工程数による拒絶処理を変更しました。

- 描画時間が短かったり、作画工程数が少ない時にお絵かき画面を警視庁のサイトにぶっとばす機能がしぃちゃんによって開発され、その仕様書どおりに警視庁のサイトにリダイレクトする掲示板が数多く存在していました。  
しかし、この機能は実用的ではなく、使い所が無い仕様になっていました。  
そこで、いきなりお絵かき画面から指定したどこかへぶっとばすのではなく、お絵かき画面に｢描画時間が短すぎます｣｢工程数が少なすぎます｣というアラートを表示する仕様に変更しました。  
  
![221027_002NEOの作画時間と工程数が不足している時はアラートを出す。](https://user-images.githubusercontent.com/44894014/198825566-dc572087-a49a-4ec4-b79b-4d0bdaa18c04.gif)

### 強制サムネイル機能が復活 
- v1.3には存在していた強制サムネイル機能を復活させました。  
最新の`thumbnail_gd.php`を使用する事でこの機能がオンになります。  
1MBを超えるファイル容量の時にはjpeg形式のサムネイル画像を出力します。  
想定されるケース。縦横のサイズは小さいもののファイルサイズが大きなGIFアニメ画像ファイルの時に、ファイルサイズが1MBを超えていたらGIFアニメではなく、jpeg形式のサムネイル画像が表示されます。  
画像をクリックすればもとのGIFアニメが表示されます。  

### そのほか
- 動的パレット配色生成箇所のコードを整理しました。
- 画像ファイルが存在しない時は動画の再生を止めてエラー画面を表示するようにしました。以前のままでも実害はありませんが、サーバにエラーログが蓄積される可能性がありました。
- 初期エラーメッセージを日本語･英語自動切り替えに変更しました。
- アップロード可能な上限数を大きめに設定。さくらのレンタルサーバでは5MBが上限なのでphp.iniの設定変更を推奨します。
- 必要のない処理を回避して負荷を削減。例えばコメントが無い時は、コメントの長さ、NGワードを調べる必要がないのですぐにreturnする事で負荷を削減します。

### Klecks更新
ゆがみを使用したあとに白く塗りつぶした箇所にゆがみの形にそった線が入る問題が修正されています。
ヘルプページに使い方の動画リンクが追加され、グラデーションのショートカットキーの項目が追加されました。

## [2022/10/03] v5.26.8

### ChickenPaintを最新版に更新
#### Chromeのバグを回避
- ChickenPaintのカラーピッカーで色を選択する操作をすると、表示されていた色が消え、真っ白になる問題がChromeのバグによって発生しました。  
  
![ChickenPaint_Chrome106_bug](https://user-images.githubusercontent.com/44894014/193554250-e09961ba-9b43-4795-b03d-d172b63f6975.gif)
  
このGoogle Chromeのバグを回避して動作するChickenPaintの最新版に更新しました。

### klecksを最新版に更新
- グラデーションツールに消しゴム化オプションが追加されました。
- 集中線を描写する機能が追加されました。

### luminousでポップアップ表示

- サムネイルをクリックすると別タブで開く従来の表示方式を見直し。同じタブにポップアップ表示するライトボックス｢luminous｣を使用して表示します。

![PetitNote220926_透過PNG](https://user-images.githubusercontent.com/44894014/193555375-50cbd382-4d1a-43cf-b721-4d44833295fb.gif)

### searchにスクロールするとでてくる上に戻るボタンを追加。

検索画面にもスクロールするとでてくる上に戻るボタンを追加しました。

## [2022/09/20] v5.26.3
### 更新
- Klecksを最新版に更新しました。  
グラデーションツールとパターンフィルタが追加されました。
- BladeOneをv4.6に更新しました。
### バグ修正
- 返信画面の記事番号に親以外の記事番号を指定すると、E-WARNINGレベルのPHPのエラーが発生するバグを修正しました。
この問題は、v5.18.12で発生し、v5.26.3で修正されました。  
正しい記事番号が指定されている時には発生しない上、軽微なエラーですがサーバのエラーログにエラーが記録され続ける可能性がありますのでアップデートをよろしくお願いします。 
`potiboard.php`をアップデートするだけでもこの問題に対応できます。  
### 改善
- コンティニュー認証と`.pch`、`.chi`、`.psd`ダウンロード認証時も、パス欄が空白の時はCookieのパスを代入するようにしました。  
編集画面ではパスワード入力欄が空白で、パスワードのCookieがあるときはCookieのパスワードがパスワードとして使用されていましたが、コンティニュー認証やダウンロード認証の時には、パスワードの入力が必要でした。    
これらの仕様を統一しました。  
- パスワード照合のための関数`check_password()`を修正。パスワードの入力がなく、Cookieのパスワードも存在しない時には鍵が開かないようにしました。  
- メール通知機能の多国語対応が不十分だったのを修正しました。  
メールのヘッダのハングル文字またはそのほかの文字が文字化けしていたのを修正しました。
- テンプレート MONOのページ番号の間隔を広げました。
- テンプレートMONOのmayoのボタンの背景色を変更しました。
- NEOのペイント画面の時計のJavaScriptを修正しました。  
- 管理画面のファイルサイズの単位をバイトからKBに変更しました。

## [2022/08/17] v5.23.8.1
### 更新
- Klecksを最新版へ。  
ノイズフィルタが追加されました。
![Screen-2022-08-15_13-31-11](https://user-images.githubusercontent.com/44894014/184819590-084df6e6-aff6-44d8-b3b3-e2fd2082a369.png)
- v5.23.8.1でv5.23.8の透明化フィルタの輝度反転が動作しない問題を修正しました。
- BladeOneをv4.5.5に更新。
- jQueryを3.6.0に更新。  
ファイルの存在チェックをしていますので、同梱のjQueryが存在しない時はプログラムが動きません。  
ファイルが存在しない事を伝えるエラーメッセージがでます。

### 改善
- クリックジャッキングの脆弱性を修正しました。
フレームまたはインラインフレームでの表示ができなくなります。  
セキュリティは向上しますが、フレーム内に表示したい方がいる事も知っています。  
そのため、config.phpに新規設定項目を追加して、フレーム内に表示するしないを選択できるようにしました。  
フレーム内に表示する必要がない方は、設定項目を追加する必要はありません。 
```
//iframe内での表示を 拒否する:1 許可する:0
//セキュリティリスクを回避するため "拒否する:1" を強く推奨。

define('X_FRAME_OPTIONS_DENY', '1');

``` 
新しくconfig.phpを1から書き直すのは大変だと思いますので、上記設定項目をどこでもいいので追加していただければ、フレーム内への表示ができるようになります。  

- モバイルユーザービリティを改善しました。  
タップターゲットのサイズ、間隔を最適化しました。

- ページの読み込み速度の改善  
jQueryや、loadcookie.jsといった外部読み込みのJavaScriptを先読みして、レンダリングをブロックしないようにしました。
- JavaScript実行のタイミングを`DOMContentLoaded` へ。  

- 注意深く記述しないと致命的エラーになる箇所を修正しました。error()関数を組み込み関数die()へ。
  
- テンプレートを直接いじらなくても、jQueryのバージョンを変更できるようにしました。
- 検索画面の画像の幅と高さを追加しました。
- 読み込み速度高速化のため最初から表示されれる範囲にloading="lazy"を適用しないようにしました。
- PaintBBS起動画面の下のタイマーのJavaScript記述が非推奨の記述方法になっていたため、修正しました。
[コンテンツセキュリティポリシーを設定したらPOTI-boardのお絵かき画面の時計が動かなくなりました。｜さとぴあ｜note](https://note.com/satopian/n/n7b757ee05975)

## [2022/07/11] v5.20.2
### 改善
- お絵かき画像の投稿時にファイル名の重複が発生する確率を1/1000に。
- 仮に重複しても投稿時刻に1秒追加。
- 投稿された画像の存在確認処理を追加し、お絵かき画像が確実にサーバに送信されてた事を確認してから画面を推移。
### 更新
- Klecksを更新しました。編集機能にグリッドが追加されました。
- BladeOneを更新しました。軽微なバグが修正されています。

## [2022/06/30] v5.19.1
- PHP7.1では動作しなくなっている事が確認されたため、必要な動作環境をPHP7.2以上に変更しました。  
PHP7.1環境では、起動せずPHPのバージョンが低い事を伝えるエラーメッセージを出します。  
- 未投稿画像のリンクはコメント未記入で画面から離れてしまったあとでも、再度投稿できるようにするためにあります。  
しかしながら、コメントの記入欄や画像のアップロード欄があり、未投稿画像がない時にも送信フォームが表示されていました。  
未投稿画像が存在しない時はフォームを表示しないようにしました。
- PaintBBSの画像を受け取り処理している`picpost.php`に画像とユーザーデータのファイルの存在確認を追加しました。  
それらの必要なファイルが存在しない時はお絵かき画面から推移せずエラーをアラートで表示します。  
画面を推移してしまうと、投稿に失敗したまま投稿画面の画像も消えてしまうためアラートで知らせます。  

## [2022/06/11] v5.18.25
### バグ修正
- レス省略件数の区切りの横線のレイアウトが崩れていたのを修正しました。  
(テンプレートMONO使用時)
### 改善
- ChickenPaintが全画面で起動するようになりました。
- futaba.phpのログファイルを読み込んで表示できるようになりました。  
カンマの数が一致しない事が原因で発生していたエラーを修正しました。  

## [2022/05/25] v5.18.9
### Klecks更新
Klecksを最新版にアップデートしました。
### CheerpJをv2.3へ
しぃペインター使用時にJavaアプレットをJavaScriptに変換するCheerpJをv2.3に更新しました。
### バグ修正
- テキストの編集時に、不要なスペースが入るバグを修正しました。
- スパム対策のための拒絶する文字列や拒絶するurlに、`/`(スラッシュ)が含まれていると正しく処理できなくなるバグを修正しました。
- テンポラリ不要ファイルの削除処理の経過日数の計算時に軽微なエラーが発生していたのを修正しました。
- 指定経過日数でレスフォームを閉じる時の日時の基準が親の投稿日時ではなく最新レスの投稿日時になっていたのを修正しました。
- Paintフォームの｢Size｣の文字の色指定が他の文字と異なっていたのを修正しました。

### コード整理
- forで記述されていた箇所をforeachへ。file()で開いていたログファイルをfopen()に変更しました。
- PCHアップロードペイントの作業ファイルの削除処理を正規表現を使用する重い関数からstrpos()に変更しました。

### 改善
- トリップ機能を再実装。
隠し機能的な再実装になりますので、テンプレート｢MONO｣でのみ表示できます。
BASICは非対応。
- 空行が存在するログファイルを処理できるようになりました。

リリースから安定版をダウンロードできます。  
[POTI-board EVO v5.18.9 リリース](https://github.com/satopian/poti-kaini/releases/latest)


## [2022/04/27] v5.16.8

### Klecksを更新しました。
- iPadOSで発生するいくつかの問題が修正されました。
- 使用可能な言語に繁体字中文が追加されました。

### テンプレートエンジンBladeOneを更新しました。

- BladeOneをv4.5.3に更新しました。

### 改善

- klecksの送信失敗の原因がサーバーエラーの時はエラー番号をアラートで表示します。
例えば、Klecksのデータを受信する`saveklecks.php`が存在しない時は、｢エラー404｣というアラートを表示します。

- ファイルサイズが指定サイズよりも大きなときに、PNGからJPEGに変換する処理の作業ディレクトリを`TEMP_DIR`に変更しました。
これにより、処理に失敗して作業ファイルのゴミが残っても、テンポラリの掃除機能で不要なファイルとして自動的に削除されるようになります。

### バグ修正
- 動画(PCH)保存ディレクトリ`define('PCH_DIR', 'src/');`に、`'src/'`以外のディレクトリが指定されている時にディレクトリの自動作成が機能せず、NEOの動画、ChickenPaintの`.chi`ファイル、klecksの`.psd`ファイルが保存できなくなっていたのを修正しました。ディレクトリが存在しない時は自動的に作成するようになりました。


## [2022/04/02] v5.16.5.1
### Klecks更新
- レイヤーの最大枚数が8枚から16枚に増えました。
### バグ修正
- テンプレートBASICのバグを修正しました。  
search画面の画像の一覧のリンクが機能していなかったのを修正しました。  
原因はHTMLの文法のミスでした。    
- search画面のHTMLの文法エラーを修正しました。 
`checked="checked"`のクオートがエスケープされて文法チェッカーでエラーになっていました。


## [2022/03/25] v5.16.5

### 改善
### Klecksの日本語訳
![image](https://user-images.githubusercontent.com/44894014/160145766-395c519f-e90e-4397-a92e-03005648906e.png)

- Klecksを日本語に翻訳しました。  
POTI-boardにも、日本語対応版を同梱する事ができました。
この新しいバージョンのKlecksは、ブラウザの言語の優先順位を自動検出して言語を切り替えてくれます。  
また、ブラウザの言語の設定にかかわらず使用する言語を指定する事もできます。  
英語、ドイツ語、日本語が選択できます。  
中文は簡体字のみで細部はまだ英語のままです。  
日本語訳のリソースはすでに開発元に統合されています。

### アプリ固有ファイルのダウンロードボタンができました。
![image](https://user-images.githubusercontent.com/44894014/160225495-64b32f7f-cb3b-4aa9-bebd-2d7453e304b4.png)
#### アプリ固有形式一覧
- `.pch`ファイル(PaintBBS)
- `.chi`ファイル(ChickenPaint)
- `.psd`ファイル(Klecks)

Klecksのレイヤー情報を含むファイルはPhotoshop形式の`.psd`ファイルです。 
ダウンロードした`.psd`ファイルはクリスタやSAIそのほか多くのアプリで開く事ができます。  
`.pch`と、`.chi`は、それぞれNEOとChickenPaintで開く事ができます。    
管理者投稿過画面から`.pch`、`.chi`、`.psd`を添付してペイントボタンを押せば、キャンバスに読み込んで投稿できます。  

####  透過PNG、透過GIFのサムネイルの透明部分を白に変更  

- 透過PNGの透明部分がJPEG化する時に、真っ黒になっていたのを修正しました。  
透明色が黒も間違いではないのですが、意図しない結果になる事が多いため、透過GIF、透過PNGからJPEGに変換する時は、透明色を白に変換します。  

### バグ修正

- 管理者ログイン時に使うアップロードペイントアプリ固有形式、pch、chi、psdなどの不要になったファイルの自動削除機能の動作時に軽微なエラーが発生するケースがあったのを修正しました。

## [2022/03/12] v5.12.0
### バグ修正
- Apple Pencilでメニューが操作できなくなっていたのを修正しました。  
ChickenPaintやKlecksのメニュー操作がで操作できなくなっていたのを修正しました。  
v3.19.5でペイント関連のテンプレートに追加したJavascriptが原因でした。  
該当のJavascriptを削除して正常に動作することを確認しました。    
### Klecksを更新
- Klecksを最新版にアップデート。  
新しいブラシが追加されました。ミラーペインティングができるようになりました。


## [2022/03/8] v5.10.0

### 機能追加
- 新しいペイントアプリKlecksに対応しました。

![image](https://user-images.githubusercontent.com/44894014/157234120-d806d24f-2f2b-4600-9d29-515a5743efd6.png)

わかりやすいUIと強力なブラシが使えるアプリです。  
レイヤーは8枚使えます。    
数多くのフィルタが使えます。輝度を透明に変換、明るさ/コントラスト、色調補正など。  

このアプリの追加にともない、管理画面からアップロードできるファイル形式に｢PSD｣が追加されました。  
PSDファイルを選択してペイントボタンを押すとKlecksのキャンバスにPSD画像が読み込まれます。  

### 改善
- 複数の未投稿画像がある時に、一番新しい画像が投稿できるようになりました。    
これまでは、コメント欄のすぐ上の画像は投稿されず画面の一番上の画像が投稿されていました。  

### バグ修正
- 強制sageが機能しなくなっていたのを修正しました。
- 未定義エラーを含む多くのマイナーなバグが修正されました。

### レガシーなコードを整理
- 古いコードを整理しました。投稿する前にプルダウンメニューでJPEG/PNGを切り替える機能やペイント画面から新しい設定でお絵かきする機能は削除されました。 
- 同梱テンプレートは対応していないものの、機能としては残っているのは文字色選択機能だけになりました。  

## [2022/02/10] v5.05.0

### バグ修正
#### テンプレートBASIC

- テンプレートBASICで管理者モードの時に｢投稿フォーム｣という文字列が｢投稿フォーム｣以外の時にも表示されていたバグを修正しました。
- img.logとtree.logの内容が一致しない時にレス画面に前後の画像を表示する機能で未定義エラーが発生する問題を修正しました。  
しかし、img.logとtree.logの内容が一致しないという時点でそのログファイルは壊れています。  
ログファイルが壊れるようなテストを行っていた過程でみつけた問題です。通常の使用ではログファイルは壊れないと思います。 

### 機能追加
#### 拒絶するURL  
拒絶する文字列で指定された文字列がURLに存在する時は拒絶するようになりました。  
また、拒絶する文字列とは別に使用できないURLの設定項目も追加しました。
```
//拒絶するurl
$badurl = array("example.com","www.example.com");
```
これまでは、URLのスパムワードチェックは何も行われていませんでした。  
### 改善
#### 日記モード

日記モードに設定しても、ペイントボタン下に表示される説明文が表示されたままになっていたのを改善しました。  
しかし、追加の説明文 `$addinfo`は表示する必要があるため、`$addinfo`が存在するときは表示するように工夫しました。

####   古いスレッドでは続きを描くのリンクを表示しない。続きを描くを許可しない。

指定日数を超えた記事の編集をロックするだけでなく、続きを描く(画像の編集)もロックするようにしました。
これらの設定項目を作ったのはパスワードが第三者によって侵害されて記事が改変されるのを防ぐためです。
記事の編集はロックされますがユーザーによる削除はできます。  
また管理者は指定日数を過ぎていてもテキストの編集ができます。    

しかし、一定の指定日数でロックがかかると困る方もいらっしゃると思います。

`define('ELAPSED_DAYS','365');`

`365`で1年以上経過したスレッドはロックされますが、

`define('ELAPSED_DAYS','0');`
  
`0`に設定するとロックされません。

- 描いている最中に指定日数を過ぎてしまった時は新規投稿になります。  
また描いている最中にスレッドが削除されていた時も新規投稿になるようにしました。    


## [2022/01/27] v5.01.03
### 概要

noteにまとめました。
[PHP8\.1対応作業。テンプレートエンジンに苦しめられる。｜さとぴあ｜note](https://note.com/satopian/n/nf69c79b75a4a)

### テンプレートエンジンをbladeOneに変更

PHP8.1環境でSkinny.phpから非推奨のエラーが発生するため、テンプレートエンジンをbladeOneに変更しました。  
しかし、それはテンプレートの互換性がなくなる事を意味します。  
拡張子`HTML`のテンプレートは、拡張子`blade.php`のテンプレートに置き換えられました。  
拡張子が`HTML`ではないのでカスタマイズが難しそうに感じられるかもしれません。
しかし、中身は従来のテンプレートとほとんど同じです。
 
同梱したテンプレートは、これまで同梱していたPINKとMONOをBladeOneで使えるように修正したものです。
PINKの背景色を白に変更。名称もBASICに変更しました。  

BASICは 黒鋼彗牙さんのCOOL SOLIDをベースにして作成したものです。  
著作表記はテンプレートの[LICENSE](https://github.com/satopian/poti-kaini/blob/master/potiboard5/templates/basic/LICENSE.md)にあります。

### テンプレートエンジンの変更で変わった事
#### PHP7.2
- PHP5.6環境でも動作するように開発していましたが、BladeOneのv4.2はPHP7.2以上の環境でなければ動作しない事がわかりました。  
POTI-board EVO v5.xにはPHP7.2以上の環境が必要になりました。  

### 改善
- 日記モードを調整しました。新規投稿は管理者のみに設定してもペイントボタンは表示されたままで、絵を描き終わって投稿を完了させようと思ったら管理パス以外での投稿はできないというエラーになっていました。  
新規投稿には管理パスが必要と設定した時点で新規投稿のためのペイントボタンが非表示になるようにしました。  
管理者投稿画面にお絵かき機能を実装して、管理者はそこからお絵かき投稿が可能になるように作り直しました。


## [2022/01/18] v3.22.8

- 今後のPHPのバージョンアップで文字列の処理にnullを入力できなくなりますが、採用しているテンプレートエンジンSkinny.phpでその箇所のエラーが発生しました。現時点では今後は使えなくなるという警告にどどまっていますがPHP9では動作が停止します。      
そのエラーがでなくなるように修正したのが今回のバージョンになります。  
しかしながら、採用しているテンプレートエンジンでエラーがでるような状況のまま使い続けるわけにもいきませんので、次のバージョンで、**BladeOneにテンプレートエンジンを入れ替え**ます。  
**バージョン3.x系統の開発を今回のバージョンで終了**し、次のメジャーバージョンアップ、**バージョン5にとりかかります**。  
ログファイルの互換性は確保します。  

リリースから安定版をダウンロードできます。  
[POTI-board EVO v3.22.8 リリース](https://github.com/satopian/poti-kaini/releases/tag/v3.22.8)

## [2021/12/22] v3.19.5

- 返信画面の下に前後のスレッドと前後のスレッドの画像が表示されるようになりました。   

![image](https://user-images.githubusercontent.com/44894014/147068447-9fda9fbe-bfbe-473a-b318-72be33f54273.png)


- レスの画像からの続きを描く時は｢新規投稿｣もレス画像になりました。  
これまでは、レスの画像から｢新規投稿｣で続きを描くと新規スレッドが作成されていました。  
- 返信したあとに表示される画面がスレッドの返信画面になりました。
これまでは、どの位置のスレッドに返信しても、投稿処理が完了するとトップページが表示されていました。
- レスモード、カタログモードからの編集･削除の処理の完了時にもとの画面が表示されるようになりました。
- 続きを描いて投稿が完了した時にスレッドの返信画面が表示されるようになりました。  
これまでは、35ページ目にある画像から続きを描いた場合でも投稿が完了した時にトップページが表示されていました。  
そのため、投稿した画像がどこにあるのか探さなければならなくなっていました。

- ChickenPaintの画面の特定の箇所でスワイプすると画面が上下に動く問題がありました。該当箇所をJavaScriptで制御しました。
- 初期設定では、index.html、設定を変更すればfoo.htmlに変更可能なトップページへのリンクが`<a href="./"></a>`となっている箇所が数箇所見つかりました。ほとんどのケースでは問題はでませんが、実害がでてしまっているサイトも存在しているため修正しました。  


## [2021/12/04] v3.15.3
- 新規設置の時に必要なindex.phpを更新しました。  
PHPのバージョンがPHP5.3以下の時にもPHPのバージョンが古い事が原因で動作しない事をエラーメッセージで表示するようにしました。  
これまでは、致命的エラーになっていました。  
そのため設置が成功しない原因がわからなくなっていました。    
- ChickenPaintのパレットを長押しした時にコンテキストメニュー(名前を付けて保存ほか)が開く問題に対応
ChickenPaintのパレットをペンで長押しした時に、不要なマウスの右クリックメニューが開いてしまう問題に対応しました。  
この問題はwindows inkをonにしている時や、Apple Pencil、またはスマホなどで発生していました。
各テーマのPaint画面のテンプレートにJavaScriptを追加する形で対応しましたので、Paint画面のテーマの更新をお願いします。  
同梱したテーマは対応ずみですが、他の作者の方が作成したテーマはまだ未対応かもしれませんし、今後も対応しないかもしれません。  
その場合は各作者の方に対応してもらうか、自分でコードを追加するなどの対応をお願いします。
```
<script>
	document.addEventListener('DOMContentLoaded',()=>{
		document.addEventListener('dblclick', (e)=>{ e.preventDefault()}, { passive: false });
		const chicken=document.querySelector('#chickenpaint-parent');
		chicken.addEventListener('contextmenu', (e)=>{
			e.preventDefault();
			e.stopPropagation();
		}, { passive: false });
	});
</script>

```
(同梱テーマは対応ずみ)

- PaintBBS NEOで、コピーやレイヤー結合を行う時に画面が上下に動く問題に対応しました。  
長方形の選択を行う事でコピーやレイヤー結合の操作を行うため、キャンバスからペンが少しはみ出る操作になる事があります。  
この時にNEOのキャンバスが上下に動く事があります。  
windows inkや、Apple Pencilを使っている時に発生します。  
iPad以上の画面の横幅を検出した時にはNEOのキャンバスの周囲の網目の上でスワイプしても画面が動かなくなるようにしました。  
スマホの時は従来と同じ動作としました。ピンチアウトでキャンバスを拡大したときにスワイプできなくなると操作不能に陥るからです。  
こちらも、同梱テーマのみの対応になる可能性があります。  
その場合は各作者の方に対応してもらうか、自分でコードを追加するなどの対応をお願いします。  
```
<script>
	function fixneo() {

		if(screen.width>767){//iPad以上の横幅の時は、NEOの網目のところでtouchmoveしない。
			console.log(screen.width);
			document.querySelector('#NEO').addEventListener('touchmove', function (e){
				e.preventDefault();
				e.stopPropagation();
			}, { passive: false });
		}
	}
	window.addEventListener('DOMContentLoaded',fixneo,false);
</script>

```
(同梱テーマは対応ずみ)

- picpost.php  
エラーメッセージの日本語･英語自動切り替えがiPadの`ja-jp`に対応していなかったを修正しました。  
これまでは、iPadまたは`ja-jp`を返す端末でエラーが発生した時に英語のエラーメッセージが表示されていました。

## [2021/11/23] v3.15.2
### `potiboard.php`の更新内容

- chiアップロードペイント後のファイルの削除処理  
管理者投稿でChickenPaint固有ファイル、chi形式のファイルをアップロードしてキャンバスに読み込んだあとのchiファイルの削除処理が抜けていたのを修正、追加しました。  
今回の修正でアップロードから5分経過していればtempディレクトリから削除されるようになりました。この修正を行う前でも、数日経過すれば不要になったファイルは削除されていました。

- 画像のALT文の見直し。続きを描く時の画像にもイラストのタイトルと作者名  
続きを描く時に表示される画像のALT文にタイトルと作者名が入るようになりました。


## [2021/11/16] v3.12.2

### potiboard.phpの更新内容

- 続きを描く時のthumbnail画像の幅と高さやHTMLの画像の幅と高さの計算方法を修正しました。  
connfig.phpの設定値を最大値としてセットし計算を最初からやり直す形になりました。  
ChickenPaintでは、画像の縦横を回転により変更可能ですが、これまでは回転するたびにサムネイル画像のサイズが小さくなっていました。  
- cookieに実際のキャンバスサイズがセットされるようになりました。これまでは、ユーザーが入力した値がそのままセットされていました。キャンバスサイズには最大値があるため、例えば最大で800pxの時に、8000pxと入力しても、実際に開くキャンバスサイズは800pxです。  
これまではこのようなケースでもcookieに8000pxがセットされていました。  
- 不正な長さのファイル名が入力された時はエラーを返すようになりました。 
- レスナンバーの長さをチェックして不正な長さの時はエラーにを返すようになりました。 
- 返信画面に表示される記事の説明文に親のコメントの全文が表示される仕様を修正し、300バイト以上は省略するようになりました。 

potiboard.phpのアップデートをお願いします。  
### picpost.phpとsave.phpの更新内容
- 外部サイトからの不正な投稿を緩和するため、投稿処理時のusercodeとcookieにセットされたusercodeをチェックするようになりました。

picpost.phpとsave.phpのアップデートをお願いします。

### テーマMONOの単語の修正 

｢書き込む｣を｢送信する｣に変更するなどいくつかのテーマのHTMLの変更を行いましたが機能としては同じなので、v3.12.2のままです。    
リリースのタグもv3.12.2のままですが、zipファイルの中身は更新されています。  

## [2021/10/31] v3.10.1 入力値チェックを強化
- パスワードの長さチェックを追加しました。
- 各入力項目の長さチェックを処理の前半に移動しました。
- 管理画面を表示した時に発生していた軽微なエラーを修正しました。

この問題を修正するために必要なファイルは、`potiboard.php`です。  
`potiboard.php`の上書きアップデートをお願いします。  

## [2021/10/27] v3.10.0 重大バグ修正

- 従来のすべてのバージョンのPOTI-boardに存在する重大な欠陥が見つかりました。  
すべてのログファイルを失う可能性があります。早急に最新版にバージョンアップしてくださいますようお願いいたします。  
- POTI-board v2(改二)を利用されている方へ。   
`potiboard.php`の差し換えのみではv3系統の全機能を使う事はできませんが、この問題に対処する事はできます。  
`potiboard.php`の上書きアップデートをお願いします。  


### [2021/10/27] v3.09.5

- 脆弱なパスワードの使用を防ぐためパスワードが5文字以下の時はエラーメッセージを出すようになりました。エラーメッセージは｢パスワードが短すぎます。最低6文字。｣。
- 第三者による記事の改ざんを防ぐため設定した日数より古いスレッドへの返信をロックする機能を拡張し古い記事の編集もロックするようになりました。  
削除はできます。また管理者は編集･削除ともに従来通り可能です。  

- 以下の設定項目が無い古いconfig.phpを使用すると、画像なしのチェックを入れたり外したりする必要がありました。  

>//画像なしのチェックボックスを使用する する:1 しない:0   
>define('USE_CHECK_NO_FILE', '0');  

このデフォルト値を｢する:1｣ から ｢しない:0｣ に変更になりました。
config.phpのバージョンが古い場合でも｢画像なし｣のチェックを入れたり外したりする必要はなくなりました。  
- サイトの著作リンクの変更。 [https://paintbbs.sakura.ne.jp/poti/](https://paintbbs.sakura.ne.jp/poti/)
 

### [2021/10/14] v3.08.1.1 

- POTI-board EVO v3.08.1 のバグを修正しました。  
必要なJavaScriptを誤って削除していたため、テーマMONOの配色の切り替えに不具合が発生していました。  
このバグの影響を受けるのは、テーマMONOです。PINKには配色切り替え機能がないためこの影響を受けません。    


### [2021/10/09] v3.08.1 

- ブラウザのヒストリーバックやエラー画面の戻るで元の画面に戻った時に送信ボタンが無効化されたままになり操作できなくなる不具合を修正しました。  

### [2021/09/28] v3.07.5
#### 細かなバグの修正
- ブラウザの言語が日本語以外の時にPaintBBSのメニューの表示がおかしくなっていたのを修正しました。 
- 描画時間計算をするしないを判断している箇所の計算方法が間違っていたのを修正しました。描画開始時間が存在しない時にも計算がはじまっていました。
- 投稿処理の途中でエラーが発生しても、未投稿画像からお絵かき画像の再投稿ができるようにしました。ワークファイルの削除を投稿処理のほぼ最後の箇所に移動しました。これまでは、投稿処理の後半でエラーが発生すると、投稿したイラストはサーバに残るものの掲示板には表示できなくなっていました。
#### IDの表示条件の仕様変更

#### 個人識別のためのId

日付が変わってもipアドレスが同じ時は同じIDを表示するようになりました。  
1日の投稿件数が数十件に及ぶケースでは一日限りのIDでも使いみちがありますが、数日間に数件しか投稿がない掲示板ではIDが意味をなさないからです。  
他のPOTI-board系統の掲示板でも同じIDが表示される可能性があります。それを回避したいときは、`config.php`で
```
//ID生成の種
define('ID_SEED', 'IDの種');

```  
を変更すれば、その掲示板で生成されるIDがユニークなものになります。  

#### UI UXを改善

- MONOのスレッドのタイトルをリンクに。
- search の画面の配色を掲示板に近づけました。

#### Chrome、Firefoxのオートコンプリートの改善

記事の編集削除の時に記事番号を入力して編集ボタンを押すと、ユーザー名を記事番号としたセットでパスワードが保存される事がありました。  

この問題を回避するためCSSで非表示にした入力欄を別途作成しました。  
これにより名前をユーザー名としたパスワードの保存が容易になります。

### [2021/08/25] search.php
- config.phpで設定したタイムゾーンがsearchに反映されず、searchの設定を変更しない限り｢Asia/Tokyo｣のままになっていたのを修正しました。  
日本時間に設定していた人の表示はなにも変わりません。


### [2021/08/22] v3.06.8 lot.210822

- ChickenPaintのアイコンが一新されました。

- テーマ MONOの配色を変更しました。  
原色系の配色を見直しました。

-  管理者削除画面  
セキュリティ向上。XSS対策を強化しました。  
1ページに表示する件数を2000件から1000件に変更しました。  

-  アップロードペイントのエラーメッセージを修正  
ファイルをアップロードしてキャンバスに読み込む機能にChickenPaintの｢chi｣ファイルも対応しているため、対応フォーマットの説明に｢chi｣を追加しました。

2021/08/23 ChickenPaintの新しいアイコンが入っていませんでした。  
修正版をリリースしましたのでお手数ですが、ChickenPaintディレクトリの上書きアップデートをお願いします。  
(v3.06.8.1) で修正済み。


### [2021/08/11] v3.05.3 lot.210811
- Tweetや通知メールがHTMLエスケープされた文字化けした文字になるためデコード処理を追加。
- Tweetに使用する、題名と名前に相当する出力の変数を追加。
#### テーマ作者向けの情報
`<% def(oya/share_sub)><% echo(oya/share_sub) %><% else %><% echo(oya/sub|urlencode) %><% /def %>`    
`<% def(oya/share_name)><% echo(oya/share_name) %><% else %><% echo(oya/name|urlencode) %><% /def %>`  
POTI-board本体のバージョンが低い時は新しく追加した変数が未定義になります。  
それを回避するため、テーマのHTMLで、変数が存在していたら新しく設定したTweet用の変数を使い、でなければ古い形式のまま出力としました。

### [2021/08/06] v3.05.2.2
- ChickenPaintがアップデートし、iOS関連の多くの不具合が解消されました。  
パームリジェクション関連の不具合が解消されました。    
手のひらとApple Pencilの識別ができるようになりました。これまでは、意図しない直線が発生していまた。  

### [2021/08/03] v3.05.2 lot.210803
- iPadでChickenPaintを使う時に、意図しないダブルタップズームが発生し、描画が困難になる問題に暫定対応しました。  
各テーマのPaint画面のHTMLの更新をお願いします。
- `<img loading="lazy">`。各テーマの`img`タグに`loading="lazy"`を追加しました。  
ディスプレイに表示されていない範囲の画像を読み込まなくなるので転送量が少しだけ減ります。  


### [2021/07/18] v3.05.1 lot.210716
- 固定トークンを使った、CSRF対策を導入しました。
サイト外部からの不正な投稿を拒絶する事ができます。  
テーマのHTMLがトークンに対応していない時は、  
`define('CHECK_CSRF_TOKEN', '1');`  
を    
`define('CHECK_CSRF_TOKEN', '0');`　
に変更します。テーマが対応していない時にこの設定を有効にすると投稿ができなくなります。  
この設定項目がconfig.phpに存在しない時は、  
`define('CHECK_CSRF_TOKEN', '0');`  
と同じ扱いになります。  
- 出力時にHTMLをチェックする方式に移行しました。管理者もHTMLタグの使用ができなくなりました。  
すでに入力済みのHTMLタグは除去されます。  
除去してさらにエスケープ処理を行ったものを出力します。 
- トップページのフォームと、各スレッドに表示するミニレスフォームを廃止しました。    
静的HTMLファイルにはCSRFトークンをセットする事ができないからです。  
- ChickenPaintがスマホ対応になりました。

### [2021/06/22] テーマMONO
- MONOのCSS切り替えのJavaScriptを大幅に更新。  
非推奨の古いJavaScriptの関数の使用をやめました。  
CSSファイルを外部からセットするのではなく、あらかじめ用意したものを読み込むかどうか指定する形になりました。  
themeディレクトリのHTML全5ファイルの上書きアップデートをお願いします。  

### [2021/06/20] メール通知クラス lot.210620
- 投稿を通知する処理を行っている`noticemail.inc`を改修。多国語対応に。

### [2021/06/17] v3.02.0 lot.210617
- ChickenPaintの画面が選択される問題に対応。
- PaintBBS NEOとしぃペインターの時は、Windows inkや二本指によるジェスチャーでブラウザバックしないようにした。
- potiboard.phpのコードを整理。global変数削減、コンティニュー時の処理をまとめた。
- MONOのCSS切り替えをプルダウンメニューに。

### [2021/06/05] v3.01.9 lot.210605
- 日本語に翻訳されたChickenPaintの最新版に更新。  
ブラウザの言語が日本語以外の場合は英語で表示。ブラウザの言語が日本語なら日本語で表示。  

- 管理画面のページング
2000件単位で改ページ。  
- メインページとカタログページのページングを改良。  
35頁単位でページングする方式に移行しました。  
- しぃペインターが起動しないCheerpJのバージョンに対処。    
CheerpJの起動に必要なJavaScriptのurlをpotiboard.phpで管理するようになりました。  

### [2021/05/23] v3.00.3 lot.210523
- ChickenPaintを日本語訳対応版にアップデートしました。
- PaintBBS NEOをv1.5.11にアップデートしました。
- `picpost.php`更新。PaintBBS NEOv1.5.11の、エラー発生時はペイント画面にとどまるようにする機能に対応しました。  
- NEOの画像から続きを描く時にJavaのPaintBBSが起動するバグを修正しました。

### [2021/05/15] v3.00.1 lot.210514
- ChickenPaintに対応しました。
- v2.xからv3.xになりました。
- それにともない、改二からEVOに名称変更しました。
- 改二のテーマも引き続き利用できます。

### [2021/04/26] v2.26.8 lot.210426
各テーマの[POTI改公式サイト](https://paintbbs.sakura.ne.jp/poti/)のURLを変更しました。  
著作表記を(C)POTI改 POTI-board redevelopment team.に変更しました。  
テーマの細かな修正を行いました。
別リポジトリで配布していたテーマファイル、[PINK](https://github.com/satopian/pink_for_poti-kaini)を同梱しました。  

### [2021/04/13] v2.26.7 lot.210410

- png2jpgの作業ディレクトリをsrcのリアルパスに。関数化される前と同じ動作になるようにしました。
### [2021/03/20] v2.26.6 lot.210320.0

- レス先が無い投稿の時に添付ファイルでアップロードした画像が画像ディレクトリに残るバグを修正。
- 続きから描いた時に画像の縦横比が正しくセットされないバグを修正。
- v2.12.7 lot.200822 から関数化されたpng2jpgの作業ディレクトリが、srcやtmpではなく、potiboard.phpと同じディレクトリだったのを変更。
- `config.php`の設定例にドメイン名の例示のために予約されているセカンドレベルドメインexample.comを使用。
- テーマのcss修正。

(by さとぴあ)


### [2021/03/09] v2.26.5 lot.210308.0

- v2.26.3の「e-mailとして不正な形式のものはリンクに出さないようにした」に関するバグの修正。

### [2021/03/07] v2.26.3 lot.210306.0

- レス先が存在しないレス投稿の時にE_WARNINGレベルのエラーが発生するのを修正 (by さとぴあ)
  - POTIv1.33b1とは別の方法で、img.logへの書き込み処理が発生しないようにした。
- ユーザー削除のエラー処理でfopen()したファイルが閉じられていなかったのを修正。
- 管理者の削除画面のバグを修正 (by さとぴあ)
  - メールアドレスを検証フィルタに通し、e-mailとして不正な形式のものはリンクに出さないようにした。
  - MD5が表示されなくなっていたのを修正。

### [2021/02/17] v2.26.2 lot.210217.0

- E_WARNINGレベルのエラーが発生していたのを修正 (by さとぴあ)
  - `potiboard.php`のほかに`picpsot.php`に変更があります。

### [2021/02/15] v2.26.1 lot.210215.0

- ログに記録されているメールやURLの形式が正しく無い時は、出力時にチェックしてリンクに出さないよう修正 (by さとぴあ)
- 記事のHTML更新の時に、form()関数がHTMLの枚数分コールされていたのを変数に代入して一回ですむようにした (by さとぴあ)
  - ごくわずかな、わからないぐらいの差です。

### [2021/02/13] v2.26.0 lot.210213.0

- Cookieにセットできない文字列があったのを修正 (by さとぴあ)

### [2021/02/13] v2.23.9 lot.210212.1

- アニメファイル(.pch/.spch)アップロード時のエラーメッセージをtemplate_ini.phpで設定できるようにした (by さとぴあ)

### [2021/02/12] v2.23.8 lot.210212.0

- 最大ログ保持数が未設定または未定義の時はエラーになるようにした (by さとぴあ)
- また、最大ログ保持数の最低値を1000件に設定 (by さとぴあ)
  - 誤った設定によりログファイルと投稿画像を失うリスクの軽減です。
- v2.23.5 lot.210209.0で発生していた、最終ページが10件未満の時に直前のページのログが入り込むバグを修正 (by さとぴあ)
  - おかしくなっていたのは表示部分でログファイルへの影響はありません。
- 最大ログ数をオーバーした時のコードを書き直した  (by さとぴあ)

### [2021/02/10] v2.23.7 lot.210210.0

- 管理者パスワードが未定義の時はエラーにするように (by さとぴあ)
- 管理モードでのみ規制するための文字列が通常の書き込みでも拒絶されていたのを修正 (by さとぴあ)
  - themeの `template_ini.php` にメッセージの追加があります。

### [2021/02/09] v2.23.6 lot.210209.1

- v2.23.5で発生したバグ修正 (by さとぴあ)

### [2021/02/09] v2.23.5 lot.210209.0

- パスワードまたはadminがNULL時かつ、管理パスの変数が設定されていない時に管理モードが開いてしまう事があるのを修正 (by さとぴあ)
config.phpが正しく設定されていればこれまでのバージョンでも問題ありません。

### [2021/02/07] v2.23.3 lot.210207.0

- お絵かきのCookieが無い時に、通常のコメントのCookieがエラーで取得できなくなっていたのを修正 (by さとぴあ)
 `loadcookie.js`の上書きアップデートをお願いします。


### [2021/02/04] v2.23.2 lot.210204.0

- コード整理 (by さとぴあ)
  - コメントのエスケープの関数、入力チェック、改行コードの関数を統合。

### [2021/02/03] v2.23.1 lot.210203.0

- メアド欄にメールアドレスとして正しい文字列が入っていないとリンクを作成しないように修正 (by さとぴあ)
  - sage とか。
- 定数に置き換えたはずのメッセージに日本語が残っていたのを修正 (by さとぴあ)
- ログ保持件数を超えた時にログファイルに大量の空行が発生する現象を修正 (by さとぴあ)
- クッキーの二重Encodeを修正 (by さとぴあ)
- readme.txt 改定 (by さこつ)


### [2021/02/02] v2.23.0 lot.210202.0

- filter_input()で取得可能な変数を関数の引数に使用しない (by さとぴあ)
- 入力チェックの関数化 (by さとぴあ)

### [2021/01/30] v2.22.6 lot.210130.0

- picpost.systemlogの設定をpicpost.phpに移動 (by さとぴあ)


### [2021/01/26] v2.22.3 lot.210126.0

- レス0件省略と表示される事があるバグを修正 (by さとぴあ)

### [2021/01/18] search.php

- PHP8環境で致命的エラーが出るバグを修正 (by さとぴあ)
- 1発言分のログが4096バイト以上の時に処理できなくなるバグを修正 (by さとぴあ)

### [2021/01/05] v2.22.2 lot.210105.0

- 多国語対応。投稿通知メールのメッセージをtemplate_ini.phpで設定できるようにした。(by さとぴあ)
  - `theme/template_ini.php` に設定項目が増えていますが、そもままでも大丈夫です。

### [2021/01/02] v2.22.1 lot.210102.0

- php8でタイムスタンプがログに存在しない時に致命的エラーが発生するのを回避 (by さとぴあ)

### [2021/01/01] picpost.php

- picpost.systemlogのパーミッションもconfig.phpで設定できるようにした。(前回の作業の漏れ)


### [2020/12/24] v2.22.0 lot.201224.0

- config.phpの設定項目を分類しなおし (by さとぴあ)

### [2020/12/22] v2.21.6 lot.201222.0

- タイムゾーンをconfig.phpで設定できるようにした (by さとぴあ)

`potiboard.php` `picpsot.php` を上書き、`config.php` に設定追加。

### [2020/12/21] v2.21.5 lot.201221.2

- 定数が2重定義になるバグを修正 (by さとぴあ)
- 投稿者名の敬称の設定がthemeのHTMLに反映されるようにした (by さとぴあ)
  - 対応テーマが必要です。(mono、nee2は対応済み)

### [2020/12/21] v2.21.4 lot.201221.1

- template_ini_phpで設定した投稿者名の敬称がthemeのHTMLに自動的に反映されるように (by さとぴあ)
  - 主に外国語版向け機能です。

### [2020/12/21] v2.21.3 lot.201221

- 多国語対応。template_ini.phpで、すべてのメッセージを設定できるようにした。(by さとぴあ)

### [2020/12/20] v2.21.2 lot.201220a

- ログファイルに投稿時間(UNIXtimestamp)が記録されていない時に致命的エラーが発生するバグを修正。(by さとぴあ)

### [2020/12/20] v2.21.1 lot.201220

- PHPが出力するファイル、ディレクトリのパーミッションの値を設定できるようにした（by さとぴあ）

### [2020/12/18] thumbnail_gd.php

- webp形式からのサムネイル作成に対応（by さとぴあ）

### [2020/12/18] v2.21.0 lot.201218

- **重要** php8環境で画像から続きを描くとエラーになるのを修正（by さとぴあ）
  - 新しいpicpost.php、search.phpへの差し換えをお願いします。PHP5.5～PHP7.xでも動作します。
- 動画表示モード、続きを描くでの時に画像がない時はエラーにする（by さとぴあ）
  - 画像が無い時はエラー表示「記事がありません」になります。
- webp仮対応（by さとぴあ）
  -画像がアップロードできるだけです。サムネイルは作成されません。しぃペインターやオリジナルのPaintBBSはwebpから続きを描けないので、何を選択してもNEOが起動します。

potiboard.php、picpost.php、search.php のアップデートをお願いします。

### [2020/12/14] v2.20.8 lot.201214

- $_REQUESTによる$modeの取得を廃止

### [2020/12/10] v2.20.5 lot.201209

- `config.php`
  - 「新規投稿でコンティニューする時にも削除キーが必要 必要:1 不要:0」のデフォルト値を0に変更。（パスワードを公開しなくても合作ができる事がわかりにくく、パスワードが公開される事例が多いため。）

- `picpost.php` `readme.txt`
  - 著作リンク（ちょむ工房URL）が現在はまったく別のサイトになっているのを修正。

### [2020/12/07] v2.20.3 lot.201207

- php8ではE_WARNINGレベルのエラーになるUndefined offsetを修正（by さとぴあ）
- `palette.txt` せぴあ→セピア(ひらがなからカタカナへ)

### [2020/12/02] v2.20.2 lot.201130

- 旧PaintBBSのPCHファイルの動画再生と続きを描くに対応
- 旧PaintBBSのPCHファイルアップロードペイントが可能に
  - (テンプレートに更新があります）

### [2020/11/27] v2.20.1 lot.201127

- 描画時間関連の軽微なエラーを修正（by さとぴあ）

### [2020/11/25] v2.20.0 lot.201123

- 続きを描いた時の描画時間を合計表示に
  - 従来は1時間10分2秒+2分6秒のように+で描画時間をつないでいましたが、1時間12分8秒のような描画時間の合計になります。従来の表記も選択可能です。
- 今回更新が必要なファイルは、`potiboard.php`、`thumbnail_gd.php`（できれば）、`config.php`（設定を変更したい場合のみ）です。

### [2020/11/22] v2.19.5 lot.201121

- 動画から続きを描く時に動画ファイルをしらべて、元のアプレットで開くようにする処理を追加しました。
- 設定を変更してお絵かきできるテーマを使用した時に発生していたバグおよび問題を修正しました。（by さとぴあ）

### [2020/11/21] v2.19.3 lot.201120

- 続きを描く時に元の画像と違うサイズのキャンバスが開くことがあるバグを修正(by さとぴあ)
  - v2.18.10 lot.201103でキャンバスサイズをCookieに記録するようになりましたが、そのキャンバスサイズが続きを描く時のキャンバスサイズにも反映されてしまうバグが見つかり報告がありました。続きを描く時のキャンバスにCookieのキャンバスサイズは使用されなくなります。

### [2020/11/17] v2.19.2 lot.201117

- lot.201110（2.19.0～）の投稿完了時間が記録されないバグを修正。
  - picpost.phpの上書きアップデートが必要です。

### [2020/11/13] v2.19.1 lot.201112

- フォームが閉じられているスレッドへの投稿はエラーにする(by さとぴあ)

### [2020/11/11] v2.19.0 lot.201110

- 未投稿画像からの投稿でもレス先への投稿になるように(by さとぴあ)
  - potiboard.phpとpicpost.phpの更新が必要です。

### [2020/11/08] v2.18.11 lot.201108

- ファイルサイズが2MBを超えている時のエラー処理の追加(by さとぴあ)
  - `$_FILES['userfile']['error']`を使ったエラーチェックを行うようにし、ファイルサイズが大きすぎる時のエラー処理が入るようにしました。サイズが大きすぎて画像がアップロードされなかった時はエラー表示になりスクリプトの実行は中断されます。

### [2020/11/04] v2.18.10 lot.201103

- キャンバスサイズ、パレット、アプレット選択の値をCookieに保存(by さとぴあ)
  - potiboard.phpとloadcookie.jsの更新が必要です。

### [2020/11/02] v2.18.9 lot.201101

- リファクター及びオートリンクの仕様変更とloadcookie.jsの更新(by さとぴあ)

### [2020/10/30] v2.18.8 lot.201028

- 逆変換テーブルのリファクターと関連するバグを修正(by さとぴあ)

### [2020/10/28] v2.18.7 lot.201026

- 軽微なエラーの修正とわかりやすい変数名への変更(by さとぴあ)

### [2020/10/24] v2.18.6 lot.201024

- 描画時間の$ptimeが未定義変数になるケースがあったのを修正。(by さとぴあ)

### [2020/10/24] v2.18.5 lot.201023

- 書き込み可能かどうかのチェックの必要がないファイルをチェックから除外。関数整理。（by さとぴあ）

### [2020/10/09] v2.18.3 lot.201008

- 画像なしのチェックボックスによるチェックは面倒なので、その機能を使用しないオプションを追加(by さとぴあ)

### [2020/10/02] v2.18.2 lot.201002

- 管理パスの厳密化(by さとぴあ)
- hiddenフィールドにパスワードの入力値がそのまま表示されていたのを修正(by さとぴあ)
- search.php
  - 波ダッシュと全角チルダを区別しない、ログの区切りのカンマの数がひとつ多かったのを修正(by さとぴあ)
- config.php
  - ログ保存件数1000は少なすぎるので2000に増やした

### [2020/09/22] theme、NEO

- 一度投稿ボタンを押すと2度目は無効になる、jQueryを使ったスクリプトをthemeに追加。
- NEO更新
  - 投稿ボタン連打でテンポラリに同じ画像が何枚も入る、続きを描く時にNEOの投稿ボタンを連打→画像がありませんとなる、このような問題を回避できます。

### [2020/09/15] v2.18.1 lot.200915

- potiboardphp search.php search.htmlに変更があります。
  - potiboard.php コード整理。行数を30行短縮。
  - search.php search.htmlの不具合の修正
  - ページ番号未入力の時にページ数が正しく認識されていなかったバグを修正。
  - 反復処理が入れ子になっていた箇所を修正。

### [2020/09/10] v2.18.0 lot.200910

- パレット切り替え機能でパレット名を任意に設定できるように(by さとぴあ)
  - potiboard.phpとconfig.phpに変更があります

### [2020/09/08] v2.17.0 lot.200908

- 記事編集しても投稿日時を変更しないようにする設定をconfig.phpに追加他(by さとぴあ)
  - potiboard.php、config.php、thumbnail_gd.php に変更があります。

### [2020/09/06] v2.16.3 lot.200906

- コード整理(by さとぴあ)
  - function filter_input_default 一箇所でしか使っていない、他の変数で使う訳でもない、ユーザー定義関数を整理
  - thumbnail_gd.php サムネイルの作成に失敗したときの返り値をFalseに変更

### [2020/09/02] v2.16.0 lot.200902

- パレットデータファイル切り替え機能を追加(by さとぴあ)
  - **config.phpに設定の追加があります**
- クリックしても何も起きない箇所のlabelタグを整理(by さとぴあ)

### [2020/08/31] v2.15.2 lot.200831

- コード整理(by さとぴあ)
- thumbnail_gd.php
  - サムネイルの作成に失敗していても、幅と高さの情報が返り値に入る可能性があったのを修正(by さとぴあ)

### [2020/08/31] v2.15.1 lot.200831

- **重要** 親の投稿が最新のときにレス画面が表示されないバグ修正

### [2020/08/30] v2.15.0 lot.200830

- 投稿途中の画像の本人確認の処理を修正 (by さとぴあ)
  - thumbnail_gd.phpも更新。


### [2020/08/29] v2.14.1 lot.200829

- コード整理(by さとぴあ)
  -「お絵かきコメント」「画像差し換え」のglobal変数をローカル変数に。
  - 描画時間の計算を「投稿フォーム」から「お絵かきコメント」に移動。

### [2020/08/28] v2.14.0 lot.200828

- 「投稿途中の絵」からの投稿でも描画時間がでるように (by さとぴあ)
- 描画時間に関する情報をuserdataに記録する方式への移行 (by さとぴあ)
  - コメントを記入しなかったお絵かき画像の投稿は「投稿途中の絵」からの投稿になります。しかし、その場合は描画時間を表示する事ができませんでした。また、描画時間が入っていても信頼性がかなり低い状態でした。 これらの問題を解決するため、描画時間の元となるお絵かき開始時間と終了時間を、userdataに記録するようにしました。**potiboard.phpだけでなく、picpost.phpの更新も必要になります。picpost.phpの上書きアップデートを同時に行わなければ描画時間は表示されなくなります。**


### [2020/08/25] v.2.12.11 lot.200825

- カタログのHTMLの縦横比が正しくなかったの修正(by さとぴあ)
- ソースコード整理(by さとぴあ＆きつねこ)
  - 使用されていない定数USE_MBを削除
  - create_res() にオプション引数を追加して、動画チェックを行うかどうかを選べるようにした
  - 親レスでしか使われていない値のセットをcreate_res() の外に出した


### [2020/08/23] v.2.12.9 lot.200823

- ソースコード整理(by きつねこ)
  - img.log 行からレス表示用データの生成ロジックを関数化など

### [2020/08/23] v.2.12.8 lot.200823

- $pictmp,$picfileを関数内に移動。カタログモードの時の画像のHTMLHTMLの幅と高さを出力できるようにした。(by さとぴあ)


### [2020/08/18] v.2.12.6 lot.200822

- v2.8.9の削除キー未入力時のバグを修正(by さとぴあ)

### [2020/08/18] v.2.12.5 lot.200818

- template_ini.phpのパスと未定義定数の確認(by さとぴあ)

### [2020/08/17] v.2.12.4 lot.200817

- 異常系を前に出してネストを浅くした(by きつねこ)

### [2020/08/17] v.2.12.3 lot.200817

- ソースコード整理(by きつねこ)

### [2020/08/13] v2.12.0 lot.200813

- テンプレートが利用できない場合にもエラーを出せるよう修正(by きつねこ)

### [2020/08/12] v2.11.0 lot.200812

- 動画表示時には `$shi` がなくても動画ファイルの存在で種類をチェックするよう修正(by きつねこ)

### [2020/08/10] v2.10.2 lot.200810

- 元画像、サムネ、動画　を削除している箇所を関数化(by きつねこ)

### [2020/08/10] v2.10.1 lot.200810

- pchかspchかチェックする場所を関数化(by きつねこ)
- is_file ～ unlink を関数化

### [2020/08/10] v2.10.0 lot.200810

- サーバーのPHPバージョンが古い場合エラーを出して動作を停止するよう修正
  - POTI-board改二の動作にはphp5.5以上の環境が必要です。

### [2020/08/08] v2.9.13 lot.200808

- ソースコード整理(by きつねこ)
  -描写時間計算ロジックを関数化

### [2020/08/05] v2.9.10 lot.200806

- ソースコード整理(by きつねこ)
  - 参照代入を値代入に変更、不要なunsetを削除
  - foreach内で1行ずつ改行コードを追加しているのを implodeで挟むよう修正


### [2020/08/03] v2.9.8 lot.200803

- カタログにレス数を表示できるように変数を追加(by funige)

### [2020/08/01] v2.8.14 lot.200801

- 新規投稿時に画像ファイルがあるときは、画像のアップロードが成功しましたとでていたが、でなくなっていたのを修正。
- オートリンク関連(by さとぴあ)


### [2020/07/31] v2.8.7 lot.200731

- ソースコード整理(by きつねこ)
  - 必ず代入される箇所を三項演算子に置換
  - 各種処理後のリダイレクトを関数化

### [2020/07/31] v2.8.6 lot.200731

- 続きを描くでneoのpchなのにしぃペインターが起動してしまうバグ修正(by さとぴあ)

### [2020/07/29] v2.8.5 lot.200729

- トリップ廃止の後方互換性確保
- `function head()` → `function basicpart()`

### [2020/07/29] v2.8.3 lot.200729

- トリップ廃止
- メールアドレスが入っていてもIDを表示。

### [2020/07/26] v2.8.0 lot.200726

- 管理者画面にアップロード欄を出す時の処理を変更(by さとぴあ)
  - 画像アップ禁止コメントのみも禁止の時は投稿フォームをださない

### [2020/07/25] v2.7.9 lot.200725

- 画像アップロード禁止でも管理者は許可
- コメントのみの新規投稿を拒否するしないの新規設定項目を追加。

### [2020/07/25] v2.7.8 lot.200725

- 画像アップロード機能を使う、使わないを設定可能できるように

### [2020/07/24] v2.7.7 lot.200723

- 負荷削減。カタログモードの時はpchの存在確認の処理をしない(by さとぴあ)

### [2020/07/23]

- index.php(初期動作用)を同梱
  - 設置がより簡単になりました。

### [2020/07/14] v2.7.6 lot.200714

- `<% echo (oya/encoded_name) %>` `<% echo (oya/res/encoded_name) %>`追加(by さとぴあ)
- search.phpをリポジトリに統合

### [2020/07/13] v2.7.5 lot.200712

- 文字列のエラーチェックを先に行いGDを使った画像関連の処理はそのあとで(by さとぴあ)

### [2020/07/12] v2.7.4 lot.200711

- 規定容量を超えるとJPEGに変換、JPEGとPNGを比較してファイルサイズが小さなほうを出力(by さとぴあ)

### [2020/07/10]

- テーマ開発用のファイルを削除しリポジトリを分離[poti-kaini-themes](https://github.com/satopian/poti-kaini-themes)

### [2020/07/10] v2.7.3 lot.200708

- 投稿されたPNG画像が指定kbを超えた時にJPEG化する処理の調整(by さとぴあ)

### [2020/07/05] v2.7.2 lot.200704

- 本文へのURLの書き込みを禁止時、通常の投稿でも削除キーが管理パスと一致すればurlの投稿ができるように

### [2020/07/01] v2.7.1 lot.200701

- neoのpchかどうかの確認時に使用する関数をバイナリセーフなものに(by さとぴあ)

### [2020/06/30] v2.7.0 lot.200630

- 動画再生の時にNEOのpchかJavaのpchかを判定(by さとぴあ)

### [2020/06/26] v2.6.8 lot.200625

- php5.6,php7.2の時に致命的エラーが発生していたv2.6.3以降のバージョンの文法ミスを修正。
- 画像アップロードやNEOのPNGファイルも設定したファイルサイズの上限を超過した時はJPEGに変換、そのJPEG画像がファイルサイズに違反していなければ投稿できるようにした。
- それにともないHTMLのフォームによるファイルサイズの制限を2MB、picpost.phpで受信できる画像のファイルサイズを3MBにそれぞれ緩和。


### [2020/06/02] v2.6.4 lot.200602

- 文字色選択のバグ修正
- config初期値変更
- メール通知設定整理 (by さとぴあ)

### [2020/06/02]

- loadcookie.js with文の見直し

### [2020/05/27]

- Skinny.php 設定変更（キャッシュを1時間→1日に）

### [2020/05/22]

- suEXECを導入してあるサーバーで動かない可能性があるのを修正(Skinny.php)


### [2020/05/20] v2.5.0 lot.200520

- スキン/テンプレートの呼び名を「テーマ(テンプレート)」に
- デフォルトテーマ(テンプレート)のディレクトリ名変更

### [2020/05/19] v2.4.0 lot.200519

- Firefox、およびcheerpJのインストールなしでもchromeでしぃペインターが使用可能に

### [2020/05/18] v2.3.3 lot.200518a

- 強制サムネイル機能を削除 (thumbnail_gd.phpのバージョンアップがあります)

### [2020/05/17] v2.3.0 lot.200517e

- ユーザー削除権限の変更(config.phpに変更があります) (by さとぴあ)

### [2020/05/17] v2.2.7 lot.200517c

- 「投稿者名をコピー」機能搭載。(by さとぴあ)

### [2020/05/17] v2.2.5 lot.200517a

- configの説明追加、デフォルト値変更。
- アプレットのセキュリティチェックに引っかかった場合のURL用htmlファイルを同梱。
  - デフォルト設定ではお絵かき掲示板のindex.htmlに飛ばされてしまうため、なぜ投稿失敗したのかがわからないから。
  - セキュリティにヒットした場合の飛び先を define('SECURITY_URL', './security_c.html'); に設定変更してください。


### [2020/05/16] v2.2.0 lot.200516b

- ミニレスフォームを日数経過で閉じる機能追加（スキンの仕様が変わりました）
- v2.1までとconfigの互換性がなくなっていますので注意。（CRYPT_PASSが大文字になっただけです）
- configデフォルト変更

### [2020/05/15] v2.0.6　lot.200515

- PROXY_CHECK関連のコードを削除(by さとぴあ)

### [2020/05/15] v2.0.4　lot.200515

- 改行の抑制とProxyチェックを廃止(by さとぴあ)

### [2020/05/15] v2.0.2　lot.200515

- palette.txtの読み込み処理(by さとぴあ)

### [2020/05/15] v2.0.1　lot.200515

- 独自タグ廃止に関するエラー修正。(2.0.0動かないです)
- スキン修正

### [2020/05/15] v2.0.0　lot.200515

- $_GETで記事の編集をできないように変更(byさとぴあ)
- 独自タグ廃止
- noticemailのutf-8以外を削除
- 満を持して2.0.0として公開

### [2020/05/14] v2.0.0a6

- デフォルトスキン変更、スキンフォルダ作成 (config.php要再設定！)
- palleteの問題に暫定対処

### [2020/05/14] v2.0.0a5

- htmlの生成に成功(byさとぴあ) 大感謝。
- スキンのエラー修整。

### [2018/09/15] v2.0.0a1

- プロジェクト開始
- ログが生成されるのは確認、HTML生成されず
